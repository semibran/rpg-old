"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var a=[],r=!0,i=!1,o=void 0;try{for(var n,l=t[Symbol.iterator]();!(r=(n=l.next()).done)&&(a.push(n.value),!e||a.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return a}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};!function(){var Oe={units:{thief:{move:5,range:1},knight:{move:3,range:1},warrior:{move:4,range:1},mage:{move:4,range:2}},equipment:{soldier:"sword",lancer:"lance",warrior:"axe",archer:"bow",thief:"dagger",knight:"shield",mage:"hat"}},t=Oe.units,e=Oe.equipment,a=Object.freeze({default:Oe,__moduleExports:Oe,units:t,equipment:e}),r=function(t,e){return t.faction===e.faction||"player"===t.faction&&"ally"===e.faction||"ally"===t.faction&&"player"===e.faction},i=Object.freeze({default:r,__moduleExports:r}),k=a&&Oe||a,x=i&&r||i,h=function(t,e){for(var a=k.units[e.class].move,r=k.units[e.class].range,i={cell:e.position,path:[e.position]},o={move:[i],attack:[]},n=[i];n.length;)for(var l=[[(h=n.shift()).cell[0]-1,h.cell[1]],[h.cell[0]+1,h.cell[1]],[h.cell[0],h.cell[1]-1],[h.cell[0],h.cell[1]+1]],s=0;s<l.length;s++){var u=(v=l[s])[0],f=(y=v[1])*t.layout.size[0]+u;if(1!==t.layout.data[f]){for(var c=0;c<o.move.length;c++){if(S(v,(b=o.move[c]).cell))break}if(!(c<o.move.length)){for(c=0;c<t.units.length;c++){if(S(v,(b=t.units[c]).position))break}if(!(c<t.units.length)||x(e,b)){var p=h.path.slice();p.push(v);var v={cell:v,path:p};c===t.units.length&&o.move.push(v),p.length-1<a&&n.push(v)}}}}var d=function(t){var e=[0,0],a=[],r=[e];for(;r.length;)for(var i=r.shift(),o=[[i[0]-1,i[1]],[i[0]+1,i[1]],[i[0],i[1]-1],[i[0],i[1]+1]],n=0;n<o.length;n++){var l=o[n],s=l[0],u=l[1],f=Math.abs(s-e[0])+Math.abs(u-e[1]);if(f){for(var c=0;c<a.length;c++){var i=a[c];if(i[0]===s&&i[1]===u)break}c<a.length||(a.push(l),f<t&&r.push(l))}}return a}(r);for(s=0;s<o.move.length;s++){var h=o.move[s];for(c=0;c<d.length;c++){var y,m=d[c],g=[u=h.cell[0]+m[0],y=h.cell[1]+m[1]];f=y*t.layout.size[0]+u;if(1!==t.layout.data[f]&&!S(g,e.position)){for(var w=0;w<o.attack.length;w++){if(S((b=o.attack[w]).cell,g))break}if(!(w<o.attack.length)){for(w=0;w<t.units.length;w++){var b;if(S((b=t.units[w]).position,g)&&x(e,b))break}w<t.units.length||o.attack.push({cell:g,path:h.path})}}}}return o};function S(t,e){return t[0]===e[0]&&t[1]===e[1]}var _={squares:[0,64,32,16],palette:[80,64,3,3],shadow:[64,48,16,16],arrows:[0,0,64,64],floor:[64,32,16,16],grass:[64,64,16,16],wall:[64,0,16,32],swords:[48,64,16,16],piece:[32,64,16,16],"symbols/shield":[64,80,6,6],"symbols/bow":[80,0,8,8],"symbols/dagger":[80,48,6,6],"symbols/sword":[32,80,8,8],"symbols/axe":[80,32,6,6],"symbols/hat":[48,80,6,6],"symbols/lance":[0,80,8,8]};function q(t,e,a,r,i){var o=document.createElement("canvas"),n=o.getContext("2d");return o.width=r,o.height=i,n.drawImage(t,-e,-a),o}var I={get:function(t,e,a){var r=4*(a*t.width+e),i=t.data[r],o=t.data[r+1],n=t.data[r+2],l=t.data[r+3];return[i,o,n,l]},replace:function(t,e,a){for(var r=0;r<t.data.length;r+=4){for(var i=0;i<4&&t.data[r+i]===e[i];i++);if(4===i)for(var i=0;i<4;i++)t.data[r+i]=a[i]}}};function z(t,e){var a=document.createElement("canvas");return a.width=t,a.height=e,a.getContext("2d")}var o,n={tiles:[{name:"grass",solid:!1},{name:"wall",solid:!0},{name:"floor",solid:!1}],layout:{size:[16,16],data:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},units:[{class:"knight",faction:"enemy",position:[7,8]},{class:"knight",faction:"enemy",position:[8,8]},{class:"mage",faction:"enemy",position:[5,4]},{class:"warrior",faction:"enemy",position:[10,7]},{class:"warrior",faction:"player",position:[6,11]},{class:"thief",faction:"player",position:[11,12]},{class:"mage",faction:"ally",position:[8,13]}]},l=n.tiles,s=n.layout,u=n.units,f=Object.freeze({default:n,__moduleExports:n,tiles:l,layout:s,units:u}),c={test:f&&n||f};function y(t,e,a){return{context:z(t,e),sprites:a,animation:null,path:null}}function Pe(t,e){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])}function Re(t,e){return t[0]===e[0]&&t[1]===e[1]}y.render=function(t,e){for(var a=t.context,r=t.sprites,i=t.animation,o=t.path,n=e.map,l=e.ranges,s=e.cursor,u=[],f=[],c=[],p=0;p<n.layout.size[1];p++)for(var v=0;v<n.layout.size[0];v++){var d=p*n.layout.size[0]+v,h=n.layout.data[d];n.tiles[h].solid?c.push({id:h,cell:[v,p]}):f.push({id:h,cell:[v,p]})}var y=!0,m=!1,g=void 0;try{for(var w,b=f[Symbol.iterator]();!(y=(w=b.next()).done);y=!0){var k=w.value,x=n.tiles[k.id],S=_slicedToArray(k.cell,2),A=S[0],_=S[1];a.drawImage(r[x.name],16*A,16*_)}}catch(t){m=!0,g=t}finally{try{!y&&b.return&&b.return()}finally{if(m)throw g}}if(i&&i.time++,null!==s.selection){var q=n.units[s.selection];if(i){if("lift"===i.type)i.time<4?i.data.offset=2*i.time:i=t.animation={type:"float",time:0,data:{target:s.selection,offset:i.data.offset,range:0}};else if("float"===i.type){var I=i.time%180/180;i.data.offset=8+2*Math.sin(2*Math.PI*I);var z=0,M=l[s.selection],T=!0,E=!1,L=void 0;try{for(var D,j=M.attack[Symbol.iterator]();!(T=(D=j.next()).done);T=!0){for(var C=D.value,F=_slicedToArray(C.cell,2),O=F[0],P=F[1],R=!0,X=0;X<M.move.length;X++){var Y=M.move[X].cell;Y[0]===O&&Y[1]===P&&(R=!1)}R&&(N=Pe(C.cell,q.position))<=i.time&&u.push({sprite:r.squares.attack,position:[16*O,16*P+2,-2]})}}catch(t){E=!0,L=t}finally{try{!T&&j.return&&j.return()}finally{if(E)throw L}}var K=!0,B=!1,G=void 0;try{for(var H,J=M.move[Symbol.iterator]();!(K=(H=J.next()).done);K=!0){var N,Q=H.value,U=_slicedToArray(Q.cell,2),V=U[0],W=U[1];(N=Pe(Q.cell,q.position))&&N<=i.time&&u.push({sprite:r.squares.move,position:[16*V,16*W,0]}),z<N&&(z=N)}}catch(t){B=!0,G=t}finally{try{!K&&J.return&&J.return()}finally{if(B)throw G}}if(i.data.range=z,Re(s.position,q.position))o=t.path=null;else{var Z=null,$=!0,tt=!1,et=void 0;try{for(var at,rt=M.move[Symbol.iterator]();!($=(at=rt.next()).done);$=!0){var it=at.value;if(Re(it.cell,s.position)){Z=it;break}}}catch(t){tt=!0,et=t}finally{try{!$&&rt.return&&rt.return()}finally{if(tt)throw et}}if(Z)o=t.path=Z.path;else{var ot=null,nt=!0,lt=!1,st=void 0;try{for(var ut,ft=M.attack[Symbol.iterator]();!(nt=(ut=ft.next()).done);nt=!0){var ct=ut.value;if(Re(ct.cell,s.position)){var pt=!0,vt=!1,dt=void 0;try{for(var ht,yt=n.units[Symbol.iterator]();!(pt=(ht=yt.next()).done);pt=!0){var mt=ht.value;if(Re(ct.cell,mt.position)){ot=mt,o=t.path=ct.path;break}}}catch(t){vt=!0,dt=t}finally{try{!pt&&yt.return&&yt.return()}finally{if(vt)throw dt}}}}}catch(t){lt=!0,st=t}finally{try{!nt&&ft.return&&ft.return()}finally{if(lt)throw st}}ot&&u.push({sprite:r.swords,position:[16*ot.position[0]+8-r.swords.width/2,16*ot.position[1]+8-r.swords.height/2,2*Math.sin(2*Math.PI*I)-16]})}if(o){var gt=_slicedToArray(o[o.length-1],2),wt=gt[0],bt=gt[1],kt=r.pieces[q.faction][Oe.equipment[q.class]];i.time%2&&u.push({sprite:kt,position:[16*wt,16*bt+3,-3]});for(var xt=0;xt<o.length;xt++){var St=_slicedToArray(o[xt],2),At=St[0],_t=St[1],qt=!1,It=!1,zt=!1,Mt=!1,Tt=o[xt-1];if(Tt){var Et=At-Tt[0],Lt=_t-Tt[1];1===Et?qt=!0:-1===Et&&(It=!0),1===Lt?zt=!0:-1===Lt&&(Mt=!0)}var Dt=o[xt+1];if(Dt){var jt=Dt[0]-At,Ct=Dt[1]-_t;-1===jt?qt=!0:1===jt&&(It=!0),-1===Ct?zt=!0:1===Ct&&(Mt=!0)}if(qt||It||zt||Mt){var Ft=null;if(qt&&It?Ft="horiz":zt&&Mt?Ft="vert":zt&&qt?Ft="upLeft":zt&&It?Ft="upRight":Mt&&qt?Ft="downLeft":Mt&&It?Ft="downRight":qt&&!xt?Ft="leftStub":It&&!xt?Ft="rightStub":zt&&!xt?Ft="upStub":Mt&&!xt?Ft="downStub":qt?Ft="left":It?Ft="right":zt?Ft="up":Mt&&(Ft="down"),Ft){var Ot=r.arrows[Ft];u.push({sprite:Ot,position:[16*At,16*_t+2,-2]})}}}}}}}else i=t.animation={type:"lift",time:0,data:{target:s.selection,offset:0}}}else if(i){var Pt=n.units[i.data.target];if("move"===i.type)i.time>=4*i.data.path.length-4&&(i=t.animation={type:"drop",time:0,data:{target:i.data.target,offset:8,range:0}});else if("drop"!==i.type)i=t.animation={type:"drop",time:0,data:{target:i.data.target,offset:i.data.offset,range:i.data.range}};else{var Rt=l[i.data.target];if(Rt){var Xt=!0,Yt=!1,Kt=void 0;try{for(var Bt,Gt=Rt.attack[Symbol.iterator]();!(Xt=(Bt=Gt.next()).done);Xt=!0){for(var Ht=Bt.value,Jt=_slicedToArray(Ht.cell,2),Nt=Jt[0],Qt=Jt[1],Ut=!0,Vt=0;Vt<Rt.move.length;Vt++){var Wt=Rt.move[Vt];Re(Ht.cell,Wt.cell)&&(Ut=!1)}Ut&&Pe(Ht.cell,Pt.position)<=i.data.range-i.time&&u.push({sprite:r.squares.attack,position:[16*Nt,16*Qt+2,-2]})}}catch(t){Yt=!0,Kt=t}finally{try{!Xt&&Gt.return&&Gt.return()}finally{if(Yt)throw Kt}}var Zt=!0,$t=!1,te=void 0;try{for(var ee,ae=Rt.move[Symbol.iterator]();!(Zt=(ee=ae.next()).done);Zt=!0){var re=ee.value,ie=_slicedToArray(re.cell,2),oe=ie[0],ne=ie[1],le=Pe(re.cell,Pt.position);le&&le<=i.data.range-i.time&&u.push({sprite:r.squares.move,position:[16*oe,16*ne]})}}catch(t){$t=!0,te=t}finally{try{!Zt&&ae.return&&ae.return()}finally{if($t)throw te}}}i.data.offset-=2,i.data.offset<0&&(i.data.offset=0,t.animation=null)}}var se=!0,ue=!1,fe=void 0;try{for(var ce,pe=c[Symbol.iterator]();!(se=(ce=pe.next()).done);se=!0){var ve=ce.value,de=_slicedToArray(ve.cell,2),he=de[0],ye=de[1];u.push({sprite:r.wall,position:[16*he,16*ye,-8]})}}catch(t){ue=!0,fe=t}finally{try{!se&&pe.return&&pe.return()}finally{if(ue)throw fe}}for(var me=0;me<n.units.length;me++){var ge=n.units[me],we=16*ge.position[0],be=16*ge.position[1],ke=0,xe=r.pieces[ge.faction][Oe.equipment[ge.class]];if(i&&me===i.data.target){if(["lift","float","drop"].includes(i.type))ke=-i.data.offset;else if("move"===i.type){var Se=Math.floor(i.time/4),Ae=i.time%4*.25,_e=i.data.path[Se],qe=i.data.path[Se+1];we=16*_e[0],be=16*_e[1],ke=-8,qe&&(we+=(16*qe[0]-we)*Ae,be+=(16*qe[1]-be)*Ae)}u.push({sprite:xe,position:[we,be+3,ke-3]})}else u.push({sprite:xe,position:[we,be+1,ke-1]});(!i||i&&i.data.target!==me||i&&i.data.target===me&&i.time%2)&&u.push({sprite:r.shadow,position:[we,be,3]})}u.sort(function(t,e){return t.position[1]-e.position[1]});var Ie=!0,ze=!1,Me=void 0;try{for(var Te,Ee=u[Symbol.iterator]();!(Ie=(Te=Ee.next()).done);Ie=!0){var Le=Te.value,De=_slicedToArray(Le.position,3),je=De[0],Ce=De[1],Fe=De[2];a.drawImage(Le.sprite,Math.round(je),Math.round(Ce+Fe))}}catch(t){ze=!0,Me=t}finally{try{!Ie&&Ee.return&&Ee.return()}finally{if(ze)throw Me}}},(o="sprites.png",new Promise(function(t,e){var a=new Image;a.src=o,a.onload=function(){t(a)},a.onerror=function(){e(new Error("Failed to load image `"+o+"`"))}})).then(function(t){var c=m.map,p=m.ranges,v=m.cursor,e=function(t){var e={};for(var a in _){var r=_slicedToArray(_[a],4),i=r[0],o=r[1],n=r[2],l=r[3];e[a]=q(t,i,o,n,l)}e.squares={attack:q(e.squares,16,0,16,16),move:q(e.squares,0,0,16,16)},e.arrows={left:q(e.arrows,0,0,16,16),right:q(e.arrows,16,0,16,16),up:q(e.arrows,32,0,16,16),down:q(e.arrows,48,0,16,16),leftStub:q(e.arrows,0,16,16,16),rightStub:q(e.arrows,16,16,16,16),upStub:q(e.arrows,32,16,16,16),downStub:q(e.arrows,48,16,16,16),upLeft:q(e.arrows,0,32,16,16),upRight:q(e.arrows,16,32,16,16),downLeft:q(e.arrows,32,32,16,16),downRight:q(e.arrows,48,32,16,16),horiz:q(e.arrows,0,48,16,16),vert:q(e.arrows,16,48,16,16)},e.pieces={player:{},enemy:{},ally:{}};var s=e.palette.getContext("2d").getImageData(0,0,3,3),u={white:[255,255,255,255],cyan:I.get(s,0,0),blue:I.get(s,1,0),navy:I.get(s,2,0),pink:I.get(s,0,1),red:I.get(s,1,1),purple:I.get(s,2,1),lime:I.get(s,0,2),green:I.get(s,1,2),teal:I.get(s,2,2)},f={player:[u.cyan,u.blue,u.navy],enemy:[u.pink,u.red,u.purple],ally:[u.lime,u.green,u.teal]},c=["sword","lance","axe","bow","dagger","shield","hat"];for(var p in f){var v=f[p],d=!0,h=!1,y=void 0;try{for(var m,g=c[Symbol.iterator]();!(d=(m=g.next()).done);d=!0){var w=m.value,b=e["symbols/"+w],k=z(16,16),x=e.piece.getContext("2d").getImageData(0,0,16,16);I.replace(x,u.cyan,v[0]),I.replace(x,u.blue,v[1]),I.replace(x,u.navy,v[2]),k.putImageData(x,0,0);var S=z(b.width,b.height);S.drawImage(b,0,0);var A=S.getImageData(0,0,b.width,b.height);I.replace(A,u.white,v[0]),S.putImageData(A,0,0),k.drawImage(S.canvas,5,5),I.replace(A,v[0],v[2]),S.putImageData(A,0,0),k.drawImage(S.canvas,5,4),e.pieces[p][w]=k.canvas}}catch(t){h=!0,y=t}finally{try{!d&&g.return&&g.return()}finally{if(h)throw y}}}return e}(t),d=y(16*c.layout.size[0],16*c.layout.size[1],e);document.body.appendChild(d.context.canvas);for(var a=0;a<c.units.length;a++){var r=c.units[a];p[a]=h(c,r)}function l(t,e){var a=d.context.canvas,r=a.width,i=a.height;return[Math.floor(t/r*16),Math.floor(e/i*16)]}y.render(d,m),requestAnimationFrame(function t(){var e=m.keys;e.held.pause&&!e.prev.pause&&(m.paused=!m.paused);m.paused||y.render(d,m);requestAnimationFrame(t);e.prev=Object.assign(e.prev,e.held)}),window.addEventListener("mousemove",function(t){var e=d.context.canvas;t.target===e&&(v.position=l(t.offsetX,t.offsetY))}),window.addEventListener("mousedown",function(t){var e=d.context.canvas;if(t.target===e){if(v.position||(v.position=l(t.offsetX,t.offsetY)),d.animation)return;for(var a=_slicedToArray(v.position,2),r=a[0],i=a[1],o=0;o<c.units.length;o++){var n=c.units[o];if(n.position[0]===r&&n.position[1]===i){v.selection=o;break}}}}),window.addEventListener("mouseup",function(t){if(null!==v.selection){var e=c.units[v.selection];if(v.position[0]===e.position[0]&&v.position[1]===e.position[1])return v.released?(v.released=!1,void(v.selection=null)):void(v.released=!0);var a=p[v.selection],r=!0,i=!1,o=void 0;try{for(var n,l=a.move[Symbol.iterator]();!(r=(n=l.next()).done);r=!0){var s=n.value;if(s.cell[0]===v.position[0]&&s.cell[1]===v.position[1]){e.position=v.position,d.animation={type:"move",time:0,data:{target:v.selection,path:s.path}};for(var u=0;u<c.units.length;u++){var f=c.units[u];p[u]=h(c,f)}break}}}catch(t){i=!0,o=t}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}v.released=!1,v.selection=null}})});var m={map:c.test,paused:!1,ranges:[],cursor:{position:null,selection:null,released:!1},keys:{prev:{},held:function(t,r){var i={},o=!1;function e(t){var e=null;if(r)for(var e in r){for(var a=0;a<r[e].length&&r[e][a]!==t.code;a++);if(a<r[e].length)break;e=null}e||(e=t.code),"keydown"===t.type?i[e]||(i[e]=1):"keyup"===t.type&&(i[e]=0),o||(o=!0,requestAnimationFrame(n))}function n(){for(var t in i)i[t]&&i[t]++;requestAnimationFrame(n)}return t.addEventListener("keydown",e),t.addEventListener("keyup",e),i}(window,{pause:["KeyP"]})}}}();