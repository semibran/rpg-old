"use strict";var _slicedToArray=function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,a){var e=[],r=!0,o=!1,n=void 0;try{for(var i,s=t[Symbol.iterator]();!(r=(i=s.next()).done)&&(e.push(i.value),!a||e.length!==a);r=!0);}catch(t){o=!0,n=t}finally{try{!r&&s.return&&s.return()}finally{if(o)throw n}}return e}(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")};!function(){var a={squares:[0,0,32,16],shadow:[16,16,16,16],grass:[32,21,16,16],wall:[0,16,16,32],piece:[32,0,16,21],"symbols/shield":[40,37,8,8],"symbols/bow":[16,32,8,8],"symbols/sword":[32,37,8,8],"symbols/axe":[24,40,8,8],"symbols/hat":[16,40,8,8],"symbols/lance":[24,32,8,8]};function M(t){return function(t,a){var e={};for(var r in a){var o=_slicedToArray(a[r],4),n=o[0],i=o[1],s=o[2],l=o[3],u=document.createElement("canvas"),c=u.getContext("2d");u.width=s,u.height=l,c.drawImage(t,-n,-i),e[r]=u}return e}(t,a)}var t={layout:{size:[16,16],data:[1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1]},units:[{class:"knight",faction:"player",position:[7,9]},{class:"warrior",faction:"enemy",position:[8,6]},{class:"lancer",faction:"enemy",position:[7,4]},{class:"soldier",faction:"ally",position:[6,7]},{class:"archer",faction:"ally",position:[9,8]},{class:"mage",faction:"player",position:[8,11]}]},e=t.layout,r=t.units,o=Object.freeze({default:t,__moduleExports:t,layout:e,units:r}),n={test:o&&t||o};function Dt(t,a){a=a||1;for(var e=t,r=[e],o=[e];o.length;){var n=o.shift(),i=Math.abs(n[0]-e[0])+Math.abs(n[1]-e[1]),s=[[n[0]-1,n[1]],[n[0]+1,n[1]],[n[0],n[1]-1],[n[0],n[1]+1]],l=!0,u=!1,c=void 0;try{for(var f,d=s[Symbol.iterator]();!(l=(f=d.next()).done);l=!0){var v=f.value,y=!0,m=!0,h=!1,p=void 0;try{for(var g,w=r[Symbol.iterator]();!(m=(g=w.next()).done);m=!0){var b=g.value;if(b[0]===v[0]&&b[1]===v[1]){y=!1;break}}}catch(t){h=!0,p=t}finally{try{!m&&w.return&&w.return()}finally{if(h)throw p}}y&&(r.push(v),i+1<a&&o.push(v))}}catch(t){u=!0,c=t}finally{try{!l&&d.return&&d.return()}finally{if(u)throw c}}}return r}var i,Bt={soldier:"sword",lancer:"lance",warrior:"axe",knight:"shield",archer:"bow",mage:"hat"};function k(t,a,e){var r=document.createElement("canvas");return r.width=t,r.height=a,{context:r.getContext("2d"),sprites:e,animation:null,squares:null}}k.render=function(t,a){for(var e=t.context,r=t.sprites,o=t.animation,n=t.squares,i=a.map,s=a.cursor,l=[],u=[],c=0;c<i.layout.size[1];c++)for(var f=0;f<i.layout.size[0];f++){var d=c*i.layout.size[0]+f,v=i.layout.data[d];0===v?l.push([f,c]):1===v&&u.push([f,c])}var y=!0,m=!1,h=void 0;try{for(var p,g=l[Symbol.iterator]();!(y=(p=g.next()).done);y=!0){var w=p.value,b=_slicedToArray(w,2),x=b[0],I=b[1];e.drawImage(r.grass,16*x,16*I)}}catch(t){m=!0,h=t}finally{try{!y&&g.return&&g.return()}finally{if(m)throw h}}if(o&&o.time++,null!==s.selection){var M=i.units[s.selection];if(o){if("lift"===o.type&&8<=o.time&&(o=t.animation={type:"float",time:0,data:{target:s.selection,offset:0,range:0}},!n)){var k="soldier"===M.class?5:"knight"===M.class?3:4,q="archer"===M.class||"mage"===M.class?2:1;n=t.squares={move:Dt(M.position,k),attack:Dt(M.position,k+q)};for(var A=0;A<n.move.length;A++)for(var S=n.move[A],_=0;_<i.units.length;_++){var E=i.units[_];if(S[0]===E.position[0]&&S[1]===E.position[1]){n.move.splice(A,1);break}}for(var T=0;T<n.attack.length;T++){var z=n.attack[T];if(z[0]===M.position[0]&&z[1]===M.position[1]){n.attack.splice(T,1);break}}}}else o=t.animation={type:"lift",time:0,data:{target:s.selection,offset:0}};if("float"===o.type){var C=0,D=!0,B=!1,F=void 0;try{for(var L,j=n.attack[Symbol.iterator]();!(D=(L=j.next()).done);D=!0){var O=L.value,P=_slicedToArray(O,2),X=P[0],Y=P[1];(Q=Math.abs(X-M.position[0])+Math.abs(Y-M.position[1]))<=o.time&&e.drawImage(r.squares.attack,16*X,16*Y),C<Q&&(C=Q)}}catch(t){B=!0,F=t}finally{try{!D&&j.return&&j.return()}finally{if(B)throw F}}var G=!0,H=!1,J=void 0;try{for(var K,N=n.move[Symbol.iterator]();!(G=(K=N.next()).done);G=!0){var Q,R=K.value,U=_slicedToArray(R,2),V=U[0],W=U[1];(Q=Math.abs(V-M.position[0])+Math.abs(W-M.position[1]))<=o.time&&e.drawImage(r.squares.move,16*V,16*W),C<Q&&(C=Q)}}catch(t){H=!0,J=t}finally{try{!G&&N.return&&N.return()}finally{if(H)throw J}}o.data.range=C}}else if(o)if("drop"!==o.type)o=t.animation={type:"drop",time:0,data:{target:o.data.target,offset:o.data.offset,range:o.data.range}};else if(n){var Z=i.units[o.data.target],$=!0,tt=!1,at=void 0;try{for(var et,rt=n.attack[Symbol.iterator]();!($=(et=rt.next()).done);$=!0){var ot=et.value,nt=_slicedToArray(ot,2),it=nt[0],st=nt[1];Math.abs(it-Z.position[0])+Math.abs(st-Z.position[1])<=o.data.range-o.time&&e.drawImage(r.squares.attack,16*it,16*st)}}catch(t){tt=!0,at=t}finally{try{!$&&rt.return&&rt.return()}finally{if(tt)throw at}}var lt=!0,ut=!1,ct=void 0;try{for(var ft,dt=n.move[Symbol.iterator]();!(lt=(ft=dt.next()).done);lt=!0){var vt=ft.value,yt=_slicedToArray(vt,2),mt=yt[0],ht=yt[1];Math.abs(mt-Z.position[0])+Math.abs(ht-Z.position[1])<=o.data.range-o.time&&e.drawImage(r.squares.move,16*mt,16*ht)}}catch(t){ut=!0,ct=t}finally{try{!lt&&dt.return&&dt.return()}finally{if(ut)throw ct}}}for(var pt=0;pt<i.units.length;pt++){var gt=i.units[pt],wt=16*gt.position[0],bt=16*gt.position[1],xt=bt,It=r.pieces[gt.faction][Bt[gt.class]];if(o&&pt===o.data.target){if("lift"===o.type)o.data.offset=Math.min(8,o.time);else if("float"===o.type){var Mt=o.time%180/180;o.data.offset=8+2*Math.sin(2*Math.PI*Mt)}else"drop"===o.type&&--o.data.offset<0&&(o.data.offset=0,t.animation=null,n=t.squares=null);xt-=o.data.offset}(!o||o&&o.data.target!==pt||o&&o.data.target===pt&&o.time%2)&&e.drawImage(r.shadow,Math.round(wt),Math.round(bt+2)),e.drawImage(It,Math.round(wt),Math.round(xt-2))}var kt=!0,qt=!1,At=void 0;try{for(var St,_t=u[Symbol.iterator]();!(kt=(St=_t.next()).done);kt=!0){var Et=St.value,Tt=_slicedToArray(Et,2),zt=Tt[0],Ct=Tt[1];e.drawImage(r.wall,16*zt,16*Ct-8)}}catch(t){qt=!0,At=t}finally{try{!kt&&_t.return&&_t.return()}finally{if(qt)throw At}}},(i="sprites.png",new Promise(function(t,a){var e=new Image;e.src=i,e.onload=function(){t(e)},e.onerror=function(){a(new Error("Failed to load image `"+i+"`"))}})).then(function(t){var s=q.map,l=q.cursor,a=M(t);a.squares={attack:_(a.squares,16,0,16,16),move:_(a.squares,0,0,16,16)},a.pieces={player:{},enemy:{},ally:{}},console.log(a);var e=_(a.piece,0,18,3,3).getContext("2d").getImageData(0,0,3,3),r={white:[255,255,255,255],lightBlue:A(e,0,0),blue:A(e,1,0),darkBlue:A(e,2,0)},o={player:[A(e,0,0),A(e,1,0),A(e,2,0)],enemy:[A(e,0,1),A(e,1,1),A(e,2,1)],ally:[A(e,0,2),A(e,1,2),A(e,2,2)]},n=["sword","lance","axe","bow","shield","hat"];for(var i in o){var u=o[i],c=!0,f=!1,d=void 0;try{for(var v,y=n[Symbol.iterator]();!(c=(v=y.next()).done);c=!0){var m=v.value,h=a["symbols/"+m],p=E(16,18),g=a.piece.getContext("2d").getImageData(0,0,16,18);S(g,r.blue,u[1]),S(g,r.darkBlue,u[2]),p.putImageData(g,0,0);var w=E(h.width,h.height);w.drawImage(h,0,0);var b=w.getImageData(0,0,h.width,h.height);S(b,r.white,u[0]),w.putImageData(b,0,0),p.drawImage(w.canvas,4,5),S(b,u[0],u[2]),w.putImageData(b,0,0),p.drawImage(w.canvas,4,4),a.pieces[i][m]=p.canvas}}catch(t){f=!0,d=t}finally{try{!c&&y.return&&y.return()}finally{if(f)throw d}}}var x=k(16*s.layout.size[0],16*s.layout.size[1],a);function I(t,a){var e=x.context.canvas,r=e.width,o=e.height;return[Math.floor(t/r*16),Math.floor(a/o*16)]}document.body.appendChild(x.context.canvas),k.render(x,q),requestAnimationFrame(function t(){k.render(x,q);requestAnimationFrame(t)}),window.addEventListener("mousemove",function(t){var a=x.context.canvas;t.target===a&&(l.position=I(t.offsetX,t.offsetY))}),window.addEventListener("mousedown",function(t){var a=x.context.canvas;if(t.target===a){l.position||(l.position=I(t.offsetX,t.offsetY));for(var e=_slicedToArray(l.position,2),r=e[0],o=e[1],n=0;n<s.units.length;n++){var i=s.units[n];if(i.position[0]===r&&i.position[1]===o){l.selection=n;break}}}}),window.addEventListener("mouseup",function(t){null!==l.selection&&(l.selection=null)})});var q={map:n.test,cursor:{position:null,selection:null}};function A(t,a,e){var r=4*(e*t.width+a);return[t.data[r],t.data[r+1],t.data[r+2],t.data[r+3]]}function S(t,a,e){for(var r=0;r<t.data.length;r+=4){for(var o=0;o<4&&t.data[r+o]===a[o];o++);if(4===o)for(o=0;o<4;o++)t.data[r+o]=e[o]}}function _(t,a,e,r,o){var n=document.createElement("canvas"),i=n.getContext("2d");return n.width=r,n.height=o,i.drawImage(t,-a,-e),n}function E(t,a){var e=document.createElement("canvas");return e.width=t,e.height=a,e.getContext("2d")}}();