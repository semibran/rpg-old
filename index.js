"use strict";var _slicedToArray=function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,a){var e=[],r=!0,o=!1,n=void 0;try{for(var i,l=t[Symbol.iterator]();!(r=(i=l.next()).done)&&(e.push(i.value),!a||e.length!==a);r=!0);}catch(t){o=!0,n=t}finally{try{!r&&l.return&&l.return()}finally{if(o)throw n}}return e}(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")};!function(){var a={squares:[0,64,32,16],shadow:[32,64,16,16],arrows:[0,0,64,64],floor:[48,64,16,16],grass:[64,53,16,16],wall:[64,0,16,32],piece:[64,32,16,21],"symbols/shield":[64,69,8,8],"symbols/bow":[72,69,8,8],"symbols/dagger":[64,77,8,8],"symbols/sword":[80,32,8,8],"symbols/axe":[72,77,8,8],"symbols/hat":[0,80,8,8],"symbols/lance":[80,0,8,8]};function S(t){return function(t,a){var e={};for(var r in a){var o=_slicedToArray(a[r],4),n=o[0],i=o[1],l=o[2],s=o[3],u=document.createElement("canvas"),d=u.getContext("2d");u.width=l,u.height=s,d.drawImage(t,-n,-i),e[r]=u}return e}(t,a)}var t={tiles:[{name:"grass",solid:!1},{name:"wall",solid:!0},{name:"floor",solid:!1}],layout:{size:[16,16],data:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},units:[{class:"knight",faction:"enemy",position:[7,8]},{class:"knight",faction:"enemy",position:[8,8]},{class:"mage",faction:"enemy",position:[5,4]},{class:"warrior",faction:"player",position:[6,11]},{class:"thief",faction:"player",position:[11,12]},{class:"mage",faction:"ally",position:[8,13]}]},e=t.tiles,r=t.layout,o=t.units,n=Object.freeze({default:t,__moduleExports:t,tiles:e,layout:r,units:o}),i={test:n&&t||n},v={units:{thief:{move:5,range:1},knight:{move:3,range:1},warrior:{move:4,range:1},mage:{move:4,range:2}}},Tt=function(t,a){for(var e=v.units[a.class].move,r=[],o=[{cell:a.position,path:[a.position]}];o.length;)for(var n=o.shift(),i=[[n.cell[0]-1,n.cell[1]],[n.cell[0]+1,n.cell[1]],[n.cell[0],n.cell[1]-1],[n.cell[0],n.cell[1]+1]],l=0;l<i.length;l++){var s=(c=i[l])[0],u=c[1]*t.layout.size[0]+s;if(1!==t.layout.data[u]){for(var d=0;d<r.length;d++){if(h(c,r[d].cell))break}if(!(d<r.length)){for(d=0;d<t.units.length;d++){if(h(c,(a=t.units[d]).position))break}if(!(d<t.units.length)){var f=n.path.slice();f.push(c);var c={cell:c,path:f};r.push(c),f.length-1<e&&o.push(c)}}}}return r};function h(t,a){return t[0]===a[0]&&t[1]===a[1]}var l,qt={soldier:"sword",lancer:"lance",warrior:"axe",archer:"bow",thief:"dagger",knight:"shield",mage:"hat"};function A(t,a,e){var r=document.createElement("canvas");return r.width=t,r.height=a,{context:r.getContext("2d"),sprites:e,animation:null,nodes:null}}A.render=function(t,a){for(var e=t.context,r=t.sprites,o=t.animation,n=t.nodes,i=a.map,l=a.cursor,s=[],u=[],d=0;d<i.layout.size[1];d++)for(var f=0;f<i.layout.size[0];f++){var c=d*i.layout.size[0]+f,v=i.layout.data[c];i.tiles[v].solid?u.push({id:v,cell:[f,d]}):s.push({id:v,cell:[f,d]})}var h=!0,m=!1,g=void 0;try{for(var y,w=s[Symbol.iterator]();!(h=(y=w.next()).done);h=!0){var p=y.value,b=i.tiles[p.id],x=_slicedToArray(p.cell,2),I=x[0],S=x[1];e.drawImage(r[b.name],16*I,16*S)}}catch(t){m=!0,g=t}finally{try{!h&&w.return&&w.return()}finally{if(m)throw g}}if(o&&o.time++,null!==l.selection){var A=i.units[l.selection];if(o){if("lift"===o.type)o.time<8?o.data.offset=o.time:(o=t.animation={type:"float",time:0,data:{target:l.selection,offset:0,range:0}},n||(n=t.nodes=Tt(i,A)));else if("float"===o.type){var M=0,k=!0,z=!1,E=void 0;try{for(var _,T=n[Symbol.iterator]();!(k=(_=T.next()).done);k=!0){var q=_.value,C=_slicedToArray(q.cell,2),L=C[0],D=C[1],R=Math.abs(L-A.position[0])+Math.abs(D-A.position[1]);R<=o.time&&e.drawImage(r.squares.move,16*L,16*D),M<R&&(M=R)}}catch(t){z=!0,E=t}finally{try{!k&&T.return&&T.return()}finally{if(z)throw E}}o.data.range=M;var B=null,F=!0,j=!1,O=void 0;try{for(var P,X=n[Symbol.iterator]();!(F=(P=X.next()).done);F=!0){var Y=P.value;if(Y.cell[0]===l.position[0]&&Y.cell[1]===l.position[1]){B=Y.path;break}}}catch(t){j=!0,O=t}finally{try{!F&&X.return&&X.return()}finally{if(j)throw O}}if(B)for(var G=0;G<B.length;G++){var H=_slicedToArray(B[G],2),J=H[0],K=H[1],N=!1,Q=!1,U=!1,V=!1,W=B[G-1];if(W){var Z=J-W[0],$=K-W[1];1===Z?N=!0:-1===Z&&(Q=!0),1===$?U=!0:-1===$&&(V=!0)}var tt=B[G+1];if(tt){var at=tt[0]-J,et=tt[1]-K;-1===at?N=!0:1===at&&(Q=!0),-1===et?U=!0:1===et&&(V=!0)}if(N||Q||U||V){var rt=null;N&&Q?rt="horiz":U&&V?rt="vert":U&&N?rt="upLeft":U&&Q?rt="upRight":V&&N?rt="downLeft":V&&Q?rt="downRight":N&&!G?rt="leftStub":Q&&!G?rt="rightStub":U&&!G?rt="upStub":V&&!G?rt="downStub":N?rt="left":Q?rt="right":U?rt="up":V&&(rt="down"),rt&&e.drawImage(r.arrows[rt],16*J,16*K)}}var ot=o.time%180/180;o.data.offset=8+2*Math.sin(2*Math.PI*ot)}}else o=t.animation={type:"lift",time:0,data:{target:l.selection,offset:0}}}else if(o){var nt=i.units[o.data.target];if("drop"!==o.type)o=t.animation={type:"drop",time:0,data:{target:o.data.target,offset:o.data.offset,range:o.data.range}};else{if(n){var it=!0,lt=!1,st=void 0;try{for(var ut,dt=n[Symbol.iterator]();!(it=(ut=dt.next()).done);it=!0){var ft=ut.value,ct=_slicedToArray(ft.cell,2),vt=ct[0],ht=ct[1];Math.abs(vt-nt.position[0])+Math.abs(ht-nt.position[1])<=o.data.range-o.time&&e.drawImage(r.squares.move,16*vt,16*ht)}}catch(t){lt=!0,st=t}finally{try{!it&&dt.return&&dt.return()}finally{if(lt)throw st}}}--o.data.offset<0&&(o.data.offset=0,t.animation=null,n=t.nodes=null)}}var mt=!0,gt=!1,yt=void 0;try{for(var wt,pt=u[Symbol.iterator]();!(mt=(wt=pt.next()).done);mt=!0){var bt=wt.value,xt=_slicedToArray(bt.cell,2),It=xt[0],St=xt[1];e.drawImage(r.wall,16*It,16*St-8)}}catch(t){gt=!0,yt=t}finally{try{!mt&&pt.return&&pt.return()}finally{if(gt)throw yt}}for(var At=0;At<i.units.length;At++){var Mt=i.units[At],kt=16*Mt.position[0],zt=16*Mt.position[1],Et=zt,_t=r.pieces[Mt.faction][qt[Mt.class]];o&&At===o.data.target&&(Et-=o.data.offset),(!o||o&&o.data.target!==At||o&&o.data.target===At&&o.time%2)&&e.drawImage(r.shadow,Math.round(kt),Math.round(zt+2)),e.drawImage(_t,Math.round(kt),Math.round(Et-2))}},(l="sprites.png",new Promise(function(t,a){var e=new Image;e.src=l,e.onload=function(){t(e)},e.onerror=function(){a(new Error("Failed to load image `"+l+"`"))}})).then(function(t){var l=M.map,s=M.cursor,a=S(t);a.squares={attack:E(a.squares,16,0,16,16),move:E(a.squares,0,0,16,16)},a.arrows={left:E(a.arrows,0,0,16,16),right:E(a.arrows,16,0,16,16),up:E(a.arrows,32,0,16,16),down:E(a.arrows,48,0,16,16),leftStub:E(a.arrows,0,16,16,16),rightStub:E(a.arrows,16,16,16,16),upStub:E(a.arrows,32,16,16,16),downStub:E(a.arrows,48,16,16,16),upLeft:E(a.arrows,0,32,16,16),upRight:E(a.arrows,16,32,16,16),downLeft:E(a.arrows,32,32,16,16),downRight:E(a.arrows,48,32,16,16),horiz:E(a.arrows,0,48,16,16),vert:E(a.arrows,16,48,16,16)},a.pieces={player:{},enemy:{},ally:{}},console.log(a);var e=E(a.piece,0,18,3,3).getContext("2d").getImageData(0,0,3,3),r={white:[255,255,255,255],lightBlue:k(e,0,0),blue:k(e,1,0),darkBlue:k(e,2,0)},o={player:[k(e,0,0),k(e,1,0),k(e,2,0)],enemy:[k(e,0,1),k(e,1,1),k(e,2,1)],ally:[k(e,0,2),k(e,1,2),k(e,2,2)]},n=["sword","lance","axe","bow","dagger","shield","hat"];for(var i in o){var u=o[i],d=!0,f=!1,c=void 0;try{for(var v,h=n[Symbol.iterator]();!(d=(v=h.next()).done);d=!0){var m=v.value,g=a["symbols/"+m],y=_(16,18),w=a.piece.getContext("2d").getImageData(0,0,16,18);z(w,r.blue,u[1]),z(w,r.darkBlue,u[2]),y.putImageData(w,0,0);var p=_(g.width,g.height);p.drawImage(g,0,0);var b=p.getImageData(0,0,g.width,g.height);z(b,r.white,u[0]),p.putImageData(b,0,0),y.drawImage(p.canvas,4,5),z(b,u[0],u[2]),p.putImageData(b,0,0),y.drawImage(p.canvas,4,4),a.pieces[i][m]=y.canvas}}catch(t){f=!0,c=t}finally{try{!d&&h.return&&h.return()}finally{if(f)throw c}}}var x=A(16*l.layout.size[0],16*l.layout.size[1],a);function I(t,a){var e=x.context.canvas,r=e.width,o=e.height;return[Math.floor(t/r*16),Math.floor(a/o*16)]}document.body.appendChild(x.context.canvas),A.render(x,M),requestAnimationFrame(function t(){A.render(x,M);requestAnimationFrame(t)}),window.addEventListener("mousemove",function(t){var a=x.context.canvas;t.target===a&&(s.position=I(t.offsetX,t.offsetY))}),window.addEventListener("mousedown",function(t){var a=x.context.canvas;if(t.target===a){s.position||(s.position=I(t.offsetX,t.offsetY));for(var e=_slicedToArray(s.position,2),r=e[0],o=e[1],n=0;n<l.units.length;n++){var i=l.units[n];if(i.position[0]===r&&i.position[1]===o){s.selection=n;break}}}}),window.addEventListener("mouseup",function(t){null!==s.selection&&(s.selection=null)})});var M={map:i.test,cursor:{position:null,selection:null}};function k(t,a,e){var r=4*(e*t.width+a);return[t.data[r],t.data[r+1],t.data[r+2],t.data[r+3]]}function z(t,a,e){for(var r=0;r<t.data.length;r+=4){for(var o=0;o<4&&t.data[r+o]===a[o];o++);if(4===o)for(o=0;o<4;o++)t.data[r+o]=e[o]}}function E(t,a,e,r,o){var n=document.createElement("canvas"),i=n.getContext("2d");return n.width=r,n.height=o,i.drawImage(t,-a,-e),n}function _(t,a){var e=document.createElement("canvas");return e.width=t,e.height=a,e.getContext("2d")}}();