"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var a=[],r=!0,n=!1,i=void 0;try{for(var o,l=e[Symbol.iterator]();!(r=(o=l.next()).done)&&(a.push(o.value),!t||a.length!==t);r=!0);}catch(e){n=!0,i=e}finally{try{!r&&l.return&&l.return()}finally{if(n)throw i}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}!function(){var zt={units:{thief:{str:1,int:0,agi:1,move:5,weapon:"knife",armor:null},knight:{str:1,int:0,agi:0,move:3,weapon:"lance",armor:"shield"},warrior:{str:2,int:0,agi:0,move:4,weapon:"axe",armor:null},mage:{str:0,int:2,agi:0,move:4,weapon:"tome",armor:null}},weapons:{knife:{type:"str",mt:1,range:1},lance:{type:"str",mt:2,range:1},axe:{type:"str",mt:1,hit:-1,range:1,pierce:!0},tome:{type:"int",mt:3,range:2}},armors:{shield:{def:2,movee:-1}},equipment:{soldier:"sword",lancer:"lance",warrior:"axe",archer:"bow",thief:"dagger",knight:"shield",mage:"hat"}},e=zt.units,t=zt.weapons,a=zt.armors,r=zt.equipment,n=Object.freeze({default:zt,__moduleExports:zt,units:e,weapons:t,armors:a,equipment:r}),i=function(e,t){return e.faction===t.faction||"player"===e.faction&&"ally"===t.faction||"ally"===e.faction&&"player"===t.faction},o=Object.freeze({default:i,__moduleExports:i}),k=n&&zt||n,I=o&&i||o,h=function(e,t){for(var a=k.units[t.class].move,r=k.weapons[k.units[t.class].weapon],n={cell:t.cell,path:[t.cell]},i={move:[n],attack:[]},o=[n];o.length;)for(var l=[[(p=o.shift()).cell[0]-1,p.cell[1]],[p.cell[0]+1,p.cell[1]],[p.cell[0],p.cell[1]-1],[p.cell[0],p.cell[1]+1]],s=0;s<l.length;s++){var c=(h=l[s])[0],u=h[1];if(!(c<0||u<0||c>=e.layout.size[0]||u>=e.layout.size[1])){var f=u*e.layout.size[0]+c,m=e.layout.data[f];if(!e.tiles[m].solid){for(var d=0;d<i.move.length;d++){if(A(h,(x=i.move[d]).cell))break}if(!(d<i.move.length)){for(d=0;d<e.units.length;d++){if(A(h,(x=e.units[d]).cell))break}if(!(d<e.units.length)||I(t,x)){var g=p.path.slice();g.push(h);var h={cell:h,path:g};d===e.units.length&&i.move.push(h),g.length-1<a&&o.push(h)}}}}}var v=function(e){var t=[0,0],a=[],r=[t];for(;r.length;)for(var n=r.shift(),i=[[n[0]-1,n[1]],[n[0]+1,n[1]],[n[0],n[1]-1],[n[0],n[1]+1]],o=0;o<i.length;o++){var l=i[o],s=l[0],c=l[1],u=Math.abs(s-t[0])+Math.abs(c-t[1]);if(u){for(var f=0;f<a.length;f++){var n=a[f];if(n[0]===s&&n[1]===c)break}f<a.length||(a.push(l),u<e&&r.push(l))}}return a}(r.range);for(s=0;s<i.move.length;s++){var p=i.move[s];for(d=0;d<v.length;d++){var y=v[d],w=[c=p.cell[0]+y[0],u=p.cell[1]+y[1]];if(!(c<0||u<0||c>=e.layout.size[0]||u>=e.layout.size[1])){f=u*e.layout.size[0]+c,m=e.layout.data[f];if(!e.tiles[m].solid&&!A(w,t.cell)){for(var b=0;b<i.attack.length;b++){if(A((x=i.attack[b]).cell,w))break}if(!(b<i.attack.length)){for(b=0;b<e.units.length;b++){var x;if(A((x=e.units[b]).cell,w)&&I(t,x))break}b<e.units.length||i.attack.push({cell:w,path:p.path})}}}}}return i.move.shift(),i};function A(e,t){return e[0]===t[0]&&e[1]===t[1]}var l={piece:{palette:[80,50,3,3],shadow:[16,120,14,14],symbols:{shield:[128,88,8,8],bow:[128,72,8,8],dagger:[128,34,8,8],sword:[128,16,8,8],axe:[128,104,8,8],hat:[128,0,8,8],lance:[128,56,8,8]},base:[96,34,16,16]},tiles:{"stairs-base":[112,56,16,16],"grass-edge":[112,0,16,16],"wall-base":[112,104,16,16],water:[112,16,16,16],floor:[112,34,16,16],bridge:[96,104,16,16],"bridge-left":[112,88,16,16],"grass-hang":[0,120,16,16],stairs:[64,120,16,16],grass:[96,120,16,16],wall:[112,120,16,16],"grass-rock":[112,72,16,16],"wall-reflection":[96,16,16,16],"bridge-right":[80,34,16,16]},ui:{cursor:[64,104,32,16],box:[64,56,48,48],squares:[80,0,32,16],arrows:[0,56,64,64],typeface:[0,0,80,56],swords:[80,16,16,18]}};function m(e,t,a,r,n){var i=document.createElement("canvas"),o=i.getContext("2d");return i.width=r,i.height=n,o.drawImage(e,-t,-a),i}var d={get:function(e,t,a){var r=4*(a*e.width+t),n=e.data[r],i=e.data[r+1],o=e.data[r+2],l=e.data[r+3];return[n,i,o,l]},replace:function(e,t,a){for(var r=0;r<e.data.length;r+=4){for(var n=0;n<4&&e.data[r+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[r+n]=a[n]}}};function g(e,t){var a=document.createElement("canvas");return a.width=e,a.height=t,a.getContext("2d")}function s(e){var t=function e(t,a){var r={};for(var n in a)if(Array.isArray(a[n])){var i=_slicedToArray(a[n],4),o=i[0],l=i[1],s=i[2],c=i[3];r[n]=m(t,o,l,s,c)}else r[n]=e(t,a[n]);return r}(e,l);return{tiles:t.tiles,pieces:function(e){var t={player:{},enemy:{},ally:{},symbols:e.symbols,shadow:e.shadow},a=e.palette.getContext("2d").getImageData(0,0,3,3),r={white:[255,255,255,255],cyan:d.get(a,0,0),blue:d.get(a,1,0),navy:d.get(a,2,0),pink:d.get(a,0,1),red:d.get(a,1,1),purple:d.get(a,2,1),lime:d.get(a,0,2),green:d.get(a,1,2),teal:d.get(a,2,2)},n={player:[r.cyan,r.blue,r.navy],enemy:[r.pink,r.red,r.purple],ally:[r.lime,r.green,r.teal]};for(var i in n){var o=n[i];for(var l in e.symbols){var s=e.symbols[l],c=g(s.width,s.height);c.drawImage(s,0,0);var u=e.base.getContext("2d").getImageData(0,0,16,16);d.replace(u,r.cyan,o[0]),d.replace(u,r.blue,o[1]),d.replace(u,r.navy,o[2]);var f=g(u.width,u.height);f.putImageData(u,0,0);var m=c.getImageData(0,0,s.width,s.height);d.replace(m,r.white,o[0]),c.putImageData(m,0,0),f.drawImage(c.canvas,4,4),d.replace(m,o[0],o[2]),c.putImageData(m,0,0),f.drawImage(c.canvas,4,3),t[i][l]=f.canvas}}return t}(t.piece),ui:function(e){var c={swords:e.swords,cursor:function(e){for(var t=e.width/16,a=new Array(t),r=0;r<t;r++)a[r]=m(e,16*r,0,16,16);return a}(e.cursor),typeface:function(e){for(var t={},a=0,r=0;r<7;r++)for(var n=0;n<10;n++){var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz'\"/ "[a++];t[i]=m(e,8*n,8*r,8,8)}return t}(e.typeface),box:{topLeft:m(e.box,0,0,16,16),top:m(e.box,16,0,16,16),topRight:m(e.box,32,0,16,16),left:m(e.box,0,16,16,16),center:m(e.box,16,16,16,16),right:m(e.box,32,16,16,16),bottomLeft:m(e.box,0,32,16,16),bottom:m(e.box,16,32,16,16),bottomRight:m(e.box,32,32,16,16)},squares:{move:m(e.squares,0,0,16,16),attack:m(e.squares,16,0,16,16)},arrows:{left:m(e.arrows,0,0,16,16),right:m(e.arrows,16,0,16,16),up:m(e.arrows,32,0,16,16),down:m(e.arrows,48,0,16,16),leftStub:m(e.arrows,0,16,16,16),rightStub:m(e.arrows,16,16,16,16),upStub:m(e.arrows,32,16,16,16),downStub:m(e.arrows,48,16,16,16),upLeft:m(e.arrows,0,32,16,16),upRight:m(e.arrows,16,32,16,16),downLeft:m(e.arrows,32,32,16,16),downRight:m(e.arrows,48,32,16,16),horiz:m(e.arrows,0,48,16,16),vert:m(e.arrows,16,48,16,16)}};return c.Text=u,c.Box=f,c.TextBox=function(e){var t=e.map(function(e){return e.length}),a=8*Math.max.apply(Math,_toConsumableArray(t)),r=8*e.length,n=f(a+32,r+32),i=document.createElement("canvas"),o=i.getContext("2d");i.width=a,i.height=r;for(var l=0;l<e.length;l++){var s=e[l];o.drawImage(u(s),0,8*l)}return n.getContext("2d").drawImage(i,16,16),n},c;function u(e){var t=document.createElement("canvas");t.width=8*e.length,t.height=8;for(var a=t.getContext("2d"),r=0;r<e.length;r++){var n=e[r],i=c.typeface[n];a.drawImage(i,8*r,0)}return t}function f(e,t){var a=Math.ceil(e/16),r=Math.ceil(t/16),n=document.createElement("canvas"),i=n.getContext("2d");n.width=e,n.height=t;for(var o=1;o<a-1;o++)i.drawImage(c.box.top,16*o,0),i.drawImage(c.box.bottom,16*o,t-16);for(var l=1;l<r-1;l++){i.drawImage(c.box.left,0,16*l),i.drawImage(c.box.right,e-16,16*l);for(var s=1;s<a-1;s++)i.drawImage(c.box.center,16*s,16*l)}return i.drawImage(c.box.topLeft,0,0),i.drawImage(c.box.topRight,n.width-16,0),i.drawImage(c.box.bottomLeft,0,n.height-16),i.drawImage(c.box.bottomRight,n.width-16,n.height-16),n}}(t.ui)}}var c={tiles:[{name:"floor",solid:!1},{name:"water",solid:!0},{name:"wall",solid:!0},{name:"stairs",solid:!1},{name:"wall-base",solid:!0},{name:"wall-reflection",solid:!0},{name:"bridge-left",solid:!1},{name:"bridge-right",solid:!1},{name:"grass",solid:!1},{name:"grass-edge",solid:!1},{name:"grass-hang",solid:!0},{name:"grass-rock",solid:!1}],layout:{size:[16,16],data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,3,3,0,0,0,2,2,2,3,3,2,2,2,2,2,2,3,3,2,2,2,2,2,2,3,3,2,2,2,2,2,2,3,3,2,2,2,4,4,4,3,3,4,4,4,4,4,4,3,3,4,4,4,5,5,5,6,7,5,5,5,5,5,5,6,7,5,5,5,10,10,10,6,7,10,10,10,10,10,10,6,7,10,10,10,9,9,9,6,7,9,9,9,9,9,9,6,7,9,9,9,8,8,8,9,9,8,8,8,8,8,8,9,9,8,11,8,8,11,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,11,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8]},units:[{class:"knight",faction:"enemy",cell:[3,3]},{class:"knight",faction:"enemy",cell:[4,3]},{class:"knight",faction:"enemy",cell:[11,3]},{class:"knight",faction:"enemy",cell:[12,3]},{class:"mage",faction:"enemy",cell:[5,1]},{class:"mage",faction:"enemy",cell:[10,1]},{class:"warrior",faction:"player",cell:[6,11]},{class:"thief",faction:"player",cell:[11,12]},{class:"mage",faction:"ally",cell:[8,13]}]},u=c.tiles,f=c.layout,v=c.units,p=Object.freeze({default:c,__moduleExports:c,tiles:u,layout:f,units:v}),y={test:p&&c||p};function w(e,t,a){return{context:g(e,t),sprites:a,cache:{time:0,dest:null,dialog:null,animation:null}}}function _t(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])}function Et(e,t){return e[0]===t[0]&&e[1]===t[1]}w.render=function(e,t){var a=e.context,r=e.sprites,n=e.cache,i=t.map,o=t.ranges,l=t.cursor,s=["tiles","shadows","pieces","squares","arrows","fg","actions","dialogs"],c={},u=!0,f=!1,m=void 0;try{for(var d,g=s[Symbol.iterator]();!(u=(d=g.next()).done);u=!0)c[d.value]=[]}catch(e){f=!0,m=e}finally{try{!u&&g.return&&g.return()}finally{if(f)throw m}}if(l.cell){var h=_slicedToArray(l.cell,2),v=h[0],p=h[1],y=p*i.layout.size[0]+v,w=i.layout.data[y],b=(i.tiles[w],Math.floor(n.time/30)%r.ui.cursor.length);c.fg.push({image:r.ui.cursor[b],position:[16*v,16*p+1,-1]})}for(var x=0;x<i.layout.size[1];x++)for(var k=0;k<i.layout.size[0];k++){var I=x*i.layout.size[0]+k,A=i.layout.data[I],S=i.tiles[A],q=r.tiles[S.name];S.solid,c.tiles.push({image:q,position:[16*k,16*x]})}if(null!==l.selection){var M=i.units[l.selection],z=zt.weapons[zt.units[M.class].weapon];if(!n.dialog){var _=r.pieces.symbols[zt.equipment[M.class]];n.dialog=r.ui.TextBox(["  "+M.class.toUpperCase(),"","HP  3/3","STR ???","INT ???","AGI ???","MOV "+zt.units[M.class].move]),n.dialog.getContext("2d").drawImage(_,16,16)}var E=8<=M.cell[0]?8:a.canvas.width-n.dialog.width-8,T=8<=M.cell[1]?8:a.canvas.height-n.dialog.height-8;if(c.dialogs.push({image:n.dialog,position:[E,T]}),n.animation){if("lift"===n.animation.type)n.animation.time<4?n.animation.offset=2*n.animation.time:n.animation={type:"float",time:0,target:n.animation.target,offset:n.animation.offset,range:0};else if("float"===n.animation.type){var C=n.animation.time%180/180,L=2*Math.sin(2*Math.PI*C);n.animation.offset=8+L;var R=0,D=o[l.selection],O=!0,j=!1,F=void 0;try{for(var P,B=D.attack[Symbol.iterator]();!(O=(P=B.next()).done);O=!0){var X=P.value,Y=_slicedToArray(X.cell,2),G=Y[0],H=Y[1],K=!0,N=!0,U=!1,V=void 0;try{for(var J,Q=D.move[Symbol.iterator]();!(N=(J=Q.next()).done);N=!0){var W=J.value;if(Et(X.cell,W.cell)){K=!1;break}}}catch(e){U=!0,V=e}finally{try{!N&&Q.return&&Q.return()}finally{if(U)throw V}}K&&(re=_t(X.cell,M.cell))<=n.animation.time&&c.squares.push({image:r.ui.squares.attack,position:[16*G,16*H,0]})}}catch(e){j=!0,F=e}finally{try{!O&&B.return&&B.return()}finally{if(j)throw F}}var Z=!0,$=!1,ee=void 0;try{for(var te,ae=D.move[Symbol.iterator]();!(Z=(te=ae.next()).done);Z=!0){var re,ne=te.value,ie=_slicedToArray(ne.cell,2),oe=ie[0],le=ie[1];(re=_t(ne.cell,M.cell))<=n.animation.time&&c.squares.push({image:r.ui.squares.move,position:[16*oe,16*le,0]}),R<re&&(R=re)}}catch(e){$=!0,ee=e}finally{try{!Z&&ae.return&&ae.return()}finally{if($)throw ee}}n.animation.range=R;var se=null;if(Et(M.cell,l.cell))se={cell:M.cell,path:null};else{var ce=!0,ue=!1,fe=void 0;try{for(var me,de=D.move[Symbol.iterator]();!(ce=(me=de.next()).done);ce=!0){var ge=me.value;if(Et(l.cell,ge.cell)){se=ge;break}}}catch(e){ue=!0,fe=e}finally{try{!ce&&de.return&&de.return()}finally{if(ue)throw fe}}}se?n.dest=se:se=n.dest;var he=null,ve=!0,pe=!1,ye=void 0;try{for(var we,be=D.attack[Symbol.iterator]();!(ve=(we=be.next()).done);ve=!0){var xe=we.value,ke=!0,Ie=!1,Ae=void 0;try{for(var Se,qe=i.units[Symbol.iterator]();!(ke=(Se=qe.next()).done);ke=!0){var Me=Se.value;if(Et(l.cell,xe.cell)&&Et(xe.cell,Me.cell)){he=Me;break}}}catch(e){Ie=!0,Ae=e}finally{try{!ke&&qe.return&&qe.return()}finally{if(Ie)throw Ae}}}}catch(e){pe=!0,ye=e}finally{try{!ve&&be.return&&be.return()}finally{if(pe)throw ye}}if(he){if(_t(se.cell,he.cell)>z.range)if(_t(M.cell,he.cell)<=z.range)se=n.dest={cell:M.cell,path:null};else{var ze=!0,_e=!1,Ee=void 0;try{for(var Te,Ce=D.move[Symbol.iterator]();!(ze=(Te=Ce.next()).done);ze=!0){var Le=Te.value;if(_t(Le.cell,he.cell)<=z.range){se=Le,n.dest=se;break}}}catch(e){_e=!0,Ee=e}finally{try{!ze&&Ce.return&&Ce.return()}finally{if(_e)throw Ee}}}var Re=r.ui.swords;c.actions.push({image:Re,position:[16*he.cell[0]+8-Re.width/2,16*he.cell[1]+8-Re.height/2,-20+L]})}var De=se.path;if(De){var Oe=_slicedToArray(se.cell,2),je=Oe[0],Fe=Oe[1],Pe=r.pieces[M.faction][zt.equipment[M.class]];n.animation.time%2&&(c.fg.push({image:Pe,position:[16*je,16*Fe+2,-10-L]}),c.shadows.push({image:r.pieces.shadow,position:[16*je,16*Fe+4,0]}));for(var Be=0;Be<De.length;Be++){var Xe=_slicedToArray(De[Be],2),Ye=Xe[0],Ge=Xe[1],He=!1,Ke=!1,Ne=!1,Ue=!1,Ve=De[Be-1];if(Ve){var Je=Ye-Ve[0],Qe=Ge-Ve[1];1===Je?He=!0:-1===Je&&(Ke=!0),1===Qe?Ne=!0:-1===Qe&&(Ue=!0)}var We=De[Be+1];if(We){var Ze=We[0]-Ye,$e=We[1]-Ge;-1===Ze?He=!0:1===Ze&&(Ke=!0),-1===$e?Ne=!0:1===$e&&(Ue=!0)}if(He||Ke||Ne||Ue){var et=null;He&&Ke?et="horiz":Ne&&Ue?et="vert":Ne&&He?et="upLeft":Ne&&Ke?et="upRight":Ue&&He?et="downLeft":Ue&&Ke?et="downRight":He&&!Be?et="leftStub":Ke&&!Be?et="rightStub":Ne&&!Be?et="upStub":Ue&&!Be?et="downStub":He?et="left":Ke?et="right":Ne?et="up":Ue&&(et="down"),et&&c.arrows.push({image:r.ui.arrows[et],position:[16*Ye,16*Ge,0]})}}}}}else n.animation={type:"lift",time:0,target:l.selection,offset:0}}else n.dialog=null,n.animation&&(i.units[n.animation.target],"move"===n.animation.type?n.animation.time>=4*n.dest.path.length-4&&(n.animation={type:"drop",time:0,target:n.animation.target,offset:8,range:0}):"drop"!==n.animation.type?n.animation={type:"drop",time:0,target:n.animation.target,offset:n.animation.offset,range:n.animation.range}:(n.animation.offset-=2,n.animation.offset<0&&(n.animation=null)));for(var tt=0;tt<i.units.length;tt++){var at=i.units[tt],rt=16*at.cell[0],nt=16*at.cell[1],it=0,ot=r.pieces[at.faction][zt.equipment[at.class]];if(n.animation&&tt===n.animation.target){if(["lift","float","drop"].includes(n.animation.type))it=-n.animation.offset;else if("move"===n.animation.type){var lt=Math.floor(n.animation.time/4),st=n.dest.path,ct=n.animation.time%4*.25,ut=st[lt],ft=st[lt+1];rt=16*ut[0],nt=16*ut[1],it=-8,ft&&(rt+=(16*ft[0]-rt)*ct,nt+=(16*ft[1]-nt)*ct)}c.fg.push({image:ot,position:[rt,nt+2,it-2]})}else c.pieces.push({image:ot,position:[rt,nt,it]});(!n.animation||n.animation&&n.animation.target!==tt||n.animation&&n.animation.target===tt&&n.animation.time%2)&&c.shadows.push({image:r.pieces.shadow,position:[rt+1,nt+4,0]})}var mt=!0,dt=!1,gt=void 0;try{for(var ht,vt=s[Symbol.iterator]();!(mt=(ht=vt.next()).done);mt=!0){var pt=c[ht.value];pt.sort(function(e,t){return e.position[1]-(e.position[2]||0)-(t.position[1]-(t.position[2]||0))});var yt=!0,wt=!1,bt=void 0;try{for(var xt,kt=pt[Symbol.iterator]();!(yt=(xt=kt.next()).done);yt=!0){var It=xt.value,At=_slicedToArray(It.position,3),St=At[0],qt=At[1],Mt=At[2];a.drawImage(It.image,Math.round(St),Math.round(qt+(Mt||0)))}}catch(e){wt=!0,bt=e}finally{try{!yt&&kt.return&&kt.return()}finally{if(wt)throw bt}}}}catch(e){dt=!0,gt=e}finally{try{!mt&&vt.return&&vt.return()}finally{if(dt)throw gt}}n.time++,n.animation&&n.animation.time++};var b,x=document.querySelector("main");(b="sprites.png",new Promise(function(e,t){var a=new Image;a.src=b,a.onload=function(){e(a)},a.onerror=function(){t(new Error("Failed to load image `"+b+"`"))}})).then(function(e){var f=S.map,m=S.ranges,d=S.cursor,g=w(256,240,s(e));x.appendChild(g.context.canvas);for(var t=0;t<f.units.length;t++){var a=f.units[t];m[t]=h(f,a)}function i(e,t){return[Math.floor(e/256*16),Math.floor(t/256*16)]}w.render(g,S),requestAnimationFrame(function e(){var t=S.keys;t.held.pause&&!t.prev.pause&&(S.paused=!S.paused);S.paused||w.render(g,S);requestAnimationFrame(e);Object.assign(t.prev,t.held)}),window.addEventListener("mousemove",function(e){var t=g.context.canvas;e.target===t&&(d.cell=i(e.offsetX,e.offsetY))}),window.addEventListener("mousedown",function(e){var t=g.context.canvas;if(e.target===t){if(d.cell||(d.cell=i(e.offsetX,e.offsetY)),null!==d.selection||g.animation)return;for(var a=_slicedToArray(d.cell,2),r=(a[0],a[1],0);r<f.units.length;r++){var n=f.units[r];if(q(n.cell,d.cell)){d.selection=r;break}}}}),window.addEventListener("mouseup",function(e){if(null!==d.selection){var t=f.units[d.selection];if(q(d.cell,t.cell))return d.released?(d.released=!1,void(d.selection=null)):void(d.released=!0);var a=m[d.selection],r=!0,n=!1,i=void 0;try{for(var o,l=a.move[Symbol.iterator]();!(r=(o=l.next()).done);r=!0){var s=o.value;if(q(d.cell,s.cell)){t.cell=d.cell,g.cache.animation={type:"move",time:0,target:d.selection,path:s.path};for(var c=0;c<f.units.length;c++){var u=f.units[c];m[c]=h(f,u)}break}}}catch(e){n=!0,i=e}finally{try{!r&&l.return&&l.return()}finally{if(n)throw i}}d.released=!1,d.selection=null}})});var S={map:y.test,paused:!1,ranges:[],cursor:{cell:null,selection:null,released:!1},keys:{prev:{},held:function(e,r){var n={},i=!1;function t(e){var t=null;if(r)for(var t in r){for(var a=0;a<r[t].length&&r[t][a]!==e.code;a++);if(a<r[t].length)break;t=null}t||(t=e.code),"keydown"===e.type?n[t]||(n[t]=1):"keyup"===e.type&&(n[t]=0),i||(i=!0,requestAnimationFrame(o))}function o(){for(var e in n)n[e]&&n[e]++;requestAnimationFrame(o)}return e.addEventListener("keydown",t),e.addEventListener("keyup",t),n}(window,{pause:["KeyP"]})}};function q(e,t){return e[0]===t[0]&&e[1]===t[1]}}();