"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var a=[],r=!0,i=!1,o=void 0;try{for(var n,l=t[Symbol.iterator]();!(r=(n=l.next()).done)&&(a.push(n.value),!e||a.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return a}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};!function(){var Re={units:{thief:{move:5,range:1},knight:{move:3,range:1},warrior:{move:4,range:1},mage:{move:4,range:2}},equipment:{soldier:"sword",lancer:"lance",warrior:"axe",archer:"bow",thief:"dagger",knight:"shield",mage:"hat"}},t=Re.units,e=Re.equipment,a=Object.freeze({default:Re,__moduleExports:Re,units:t,equipment:e}),r=function(t,e){return t.faction===e.faction||"player"===t.faction&&"ally"===e.faction||"ally"===t.faction&&"player"===e.faction},i=Object.freeze({default:r,__moduleExports:r}),x=a&&Re||a,k=i&&r||i,h=function(t,e){for(var a=x.units[e.class].move,r=x.units[e.class].range,i={cell:e.position,path:[e.position]},o={move:[i],attack:[]},n=[i];n.length;)for(var l=[[(h=n.shift()).cell[0]-1,h.cell[1]],[h.cell[0]+1,h.cell[1]],[h.cell[0],h.cell[1]-1],[h.cell[0],h.cell[1]+1]],s=0;s<l.length;s++){var f=(p=l[s])[0],u=(y=p[1])*t.layout.size[0]+f;if(1!==t.layout.data[u]){for(var c=0;c<o.move.length;c++){if(S(p,(b=o.move[c]).cell))break}if(!(c<o.move.length)){for(c=0;c<t.units.length;c++){if(S(p,(b=t.units[c]).position))break}if(!(c<t.units.length)||k(e,b)){var v=h.path.slice();v.push(p);var p={cell:p,path:v};c===t.units.length&&o.move.push(p),v.length-1<a&&n.push(p)}}}}var d=function(t){var e=[0,0],a=[],r=[e];for(;r.length;)for(var i=r.shift(),o=[[i[0]-1,i[1]],[i[0]+1,i[1]],[i[0],i[1]-1],[i[0],i[1]+1]],n=0;n<o.length;n++){var l=o[n],s=l[0],f=l[1],u=Math.abs(s-e[0])+Math.abs(f-e[1]);if(u){for(var c=0;c<a.length;c++){var i=a[c];if(i[0]===s&&i[1]===f)break}c<a.length||(a.push(l),u<t&&r.push(l))}}return a}(r);for(s=0;s<o.move.length;s++){var h=o.move[s];for(c=0;c<d.length;c++){var y,m=d[c],g=[f=h.cell[0]+m[0],y=h.cell[1]+m[1]];u=y*t.layout.size[0]+f;if(1!==t.layout.data[u]&&!S(g,e.position)){for(var w=0;w<o.attack.length;w++){if(S((b=o.attack[w]).cell,g))break}if(!(w<o.attack.length)){for(w=0;w<t.units.length;w++){var b;if(S((b=t.units[w]).position,g)&&k(e,b))break}w<t.units.length||o.attack.push({cell:g,path:h.path})}}}}return o};function S(t,e){return t[0]===e[0]&&t[1]===e[1]}var A={squares:[0,64,32,16],palette:[80,64,3,3],shadow:[64,48,16,16],arrows:[0,0,64,64],floor:[64,32,16,16],grass:[64,64,16,16],wall:[64,0,16,32],swords:[48,64,16,16],piece:[32,64,16,16],"symbols/shield":[64,80,6,6],"symbols/bow":[80,0,8,8],"symbols/dagger":[80,48,6,6],"symbols/sword":[32,80,8,8],"symbols/axe":[80,32,6,6],"symbols/hat":[48,80,6,6],"symbols/lance":[0,80,8,8]};function I(t,e,a,r,i){var o=document.createElement("canvas"),n=o.getContext("2d");return o.width=r,o.height=i,n.drawImage(t,-e,-a),o}var q={get:function(t,e,a){var r=4*(a*t.width+e),i=t.data[r],o=t.data[r+1],n=t.data[r+2],l=t.data[r+3];return[i,o,n,l]},replace:function(t,e,a){for(var r=0;r<t.data.length;r+=4){for(var i=0;i<4&&t.data[r+i]===e[i];i++);if(4===i)for(var i=0;i<4;i++)t.data[r+i]=a[i]}}};function z(t,e){var a=document.createElement("canvas");return a.width=t,a.height=e,a.getContext("2d")}var o,n={tiles:[{name:"grass",solid:!1},{name:"wall",solid:!0},{name:"floor",solid:!1}],layout:{size:[16,16],data:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},units:[{class:"knight",faction:"enemy",position:[7,8]},{class:"knight",faction:"enemy",position:[8,8]},{class:"mage",faction:"enemy",position:[5,4]},{class:"warrior",faction:"enemy",position:[10,7]},{class:"warrior",faction:"player",position:[6,11]},{class:"thief",faction:"player",position:[11,12]},{class:"mage",faction:"ally",position:[8,13]}]},l=n.tiles,s=n.layout,f=n.units,u=Object.freeze({default:n,__moduleExports:n,tiles:l,layout:s,units:f}),c={test:u&&n||u};function y(t,e,a){return{context:z(t,e),sprites:a,animation:null,path:null}}function Fe(t,e){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])}function Pe(t,e){return t[0]===e[0]&&t[1]===e[1]}y.render=function(t,e){for(var a=t.context,r=t.sprites,i=t.animation,o=t.path,n=e.map,l=e.ranges,s=e.cursor,f=[],u=[],c=[],v=0;v<n.layout.size[1];v++)for(var p=0;p<n.layout.size[0];p++){var d=v*n.layout.size[0]+p,h=n.layout.data[d];n.tiles[h].solid?c.push({id:h,cell:[p,v]}):u.push({id:h,cell:[p,v]})}var y=!0,m=!1,g=void 0;try{for(var w,b=u[Symbol.iterator]();!(y=(w=b.next()).done);y=!0){var x=w.value,k=n.tiles[x.id],S=_slicedToArray(x.cell,2),_=S[0],A=S[1];a.drawImage(r[k.name],16*_,16*A)}}catch(t){m=!0,g=t}finally{try{!y&&b.return&&b.return()}finally{if(m)throw g}}if(i&&i.time++,null!==s.selection){var I=n.units[s.selection];if(i){if("lift"===i.type)i.time<4?i.data.offset=2*i.time:i=t.animation={type:"float",time:0,data:{target:s.selection,offset:i.data.offset,range:0}};else if("float"===i.type){var q=i.time%180/180;i.data.offset=8+2*Math.sin(2*Math.PI*q);var z=0,M=l[s.selection],T=!0,E=!1,L=void 0;try{for(var D,C=M.attack[Symbol.iterator]();!(T=(D=C.next()).done);T=!0){for(var j=D.value,O=_slicedToArray(j.cell,2),R=O[0],F=O[1],P=!0,X=0;X<M.move.length;X++){var Y=M.move[X].cell;Y[0]===R&&Y[1]===F&&(P=!1)}P&&(N=Fe(j.cell,I.position))<=i.time&&f.push({sprite:r.squares.attack,position:[16*R,16*F+2,-2]})}}catch(t){E=!0,L=t}finally{try{!T&&C.return&&C.return()}finally{if(E)throw L}}var B=!0,G=!1,H=void 0;try{for(var J,K=M.move[Symbol.iterator]();!(B=(J=K.next()).done);B=!0){var N,Q=J.value,U=_slicedToArray(Q.cell,2),V=U[0],W=U[1];(N=Fe(Q.cell,I.position))&&N<=i.time&&f.push({sprite:r.squares.move,position:[16*V,16*W,0]}),z<N&&(z=N)}}catch(t){G=!0,H=t}finally{try{!B&&K.return&&K.return()}finally{if(G)throw H}}if(i.data.range=z,Pe(s.position,I.position))o=t.path=null;else{var Z=null,$=!0,tt=!1,et=void 0;try{for(var at,rt=M.move[Symbol.iterator]();!($=(at=rt.next()).done);$=!0){var it=at.value;if(Pe(it.cell,s.position)){Z=it;break}}}catch(t){tt=!0,et=t}finally{try{!$&&rt.return&&rt.return()}finally{if(tt)throw et}}if(Z)o=t.path=Z.path;else{var ot=null,nt=!0,lt=!1,st=void 0;try{for(var ft,ut=M.attack[Symbol.iterator]();!(nt=(ft=ut.next()).done);nt=!0){var ct=ft.value;if(Pe(ct.cell,s.position)){var vt=!0,pt=!1,dt=void 0;try{for(var ht,yt=n.units[Symbol.iterator]();!(vt=(ht=yt.next()).done);vt=!0){var mt=ht.value;if(Pe(ct.cell,mt.position)){ot=mt,o=t.path=ct.path;break}}}catch(t){pt=!0,dt=t}finally{try{!vt&&yt.return&&yt.return()}finally{if(pt)throw dt}}}}}catch(t){lt=!0,st=t}finally{try{!nt&&ut.return&&ut.return()}finally{if(lt)throw st}}ot&&f.push({sprite:r.swords,position:[16*ot.position[0]+8-r.swords.width/2,16*ot.position[1]+8-r.swords.height/2,2*Math.sin(2*Math.PI*q)-16]})}if(o){var gt=_slicedToArray(o[o.length-1],2),wt=gt[0],bt=gt[1],xt=r.pieces[I.faction][Re.equipment[I.class]];i.time%2&&f.push({sprite:xt,position:[16*wt,16*bt+3,-3]});for(var kt=0;kt<o.length;kt++){var St=_slicedToArray(o[kt],2),_t=St[0],At=St[1],It=!1,qt=!1,zt=!1,Mt=!1,Tt=o[kt-1];if(Tt){var Et=_t-Tt[0],Lt=At-Tt[1];1===Et?It=!0:-1===Et&&(qt=!0),1===Lt?zt=!0:-1===Lt&&(Mt=!0)}var Dt=o[kt+1];if(Dt){var Ct=Dt[0]-_t,jt=Dt[1]-At;-1===Ct?It=!0:1===Ct&&(qt=!0),-1===jt?zt=!0:1===jt&&(Mt=!0)}if(It||qt||zt||Mt){var Ot=null;if(It&&qt?Ot="horiz":zt&&Mt?Ot="vert":zt&&It?Ot="upLeft":zt&&qt?Ot="upRight":Mt&&It?Ot="downLeft":Mt&&qt?Ot="downRight":It&&!kt?Ot="leftStub":qt&&!kt?Ot="rightStub":zt&&!kt?Ot="upStub":Mt&&!kt?Ot="downStub":It?Ot="left":qt?Ot="right":zt?Ot="up":Mt&&(Ot="down"),Ot){var Rt=r.arrows[Ot];f.push({sprite:Rt,position:[16*_t,16*At+2,-2]})}}}}}}}else i=t.animation={type:"lift",time:0,data:{target:s.selection,offset:0}}}else if(i){var Ft=n.units[i.data.target];if("move"===i.type)i.time>=4*i.data.path.length-4&&(i=t.animation={type:"drop",time:0,data:{target:i.data.target,offset:8,range:0}});else if("drop"!==i.type)i=t.animation={type:"drop",time:0,data:{target:i.data.target,offset:i.data.offset,range:i.data.range}};else{var Pt=l[i.data.target];if(Pt){var Xt=!0,Yt=!1,Bt=void 0;try{for(var Gt,Ht=Pt.attack[Symbol.iterator]();!(Xt=(Gt=Ht.next()).done);Xt=!0){for(var Jt=Gt.value,Kt=_slicedToArray(Jt.cell,2),Nt=Kt[0],Qt=Kt[1],Ut=!0,Vt=0;Vt<Pt.move.length;Vt++){var Wt=Pt.move[Vt];Pe(Jt.cell,Wt.cell)&&(Ut=!1)}Ut&&Fe(Jt.cell,Ft.position)<=i.data.range-i.time&&f.push({sprite:r.squares.attack,position:[16*Nt,16*Qt+2,-2]})}}catch(t){Yt=!0,Bt=t}finally{try{!Xt&&Ht.return&&Ht.return()}finally{if(Yt)throw Bt}}var Zt=!0,$t=!1,te=void 0;try{for(var ee,ae=Pt.move[Symbol.iterator]();!(Zt=(ee=ae.next()).done);Zt=!0){var re=ee.value,ie=_slicedToArray(re.cell,2),oe=ie[0],ne=ie[1],le=Fe(re.cell,Ft.position);le&&le<=i.data.range-i.time&&f.push({sprite:r.squares.move,position:[16*oe,16*ne]})}}catch(t){$t=!0,te=t}finally{try{!Zt&&ae.return&&ae.return()}finally{if($t)throw te}}}i.data.offset-=2,i.data.offset<0&&(i.data.offset=0,t.animation=null)}}var se=!0,fe=!1,ue=void 0;try{for(var ce,ve=c[Symbol.iterator]();!(se=(ce=ve.next()).done);se=!0){var pe=ce.value,de=_slicedToArray(pe.cell,2),he=de[0],ye=de[1];f.push({sprite:r.wall,position:[16*he,16*ye,-8]})}}catch(t){fe=!0,ue=t}finally{try{!se&&ve.return&&ve.return()}finally{if(fe)throw ue}}for(var me=0;me<n.units.length;me++){var ge=n.units[me],we=16*ge.position[0],be=16*ge.position[1],xe=0,ke=r.pieces[ge.faction][Re.equipment[ge.class]];if(i&&me===i.data.target){if(["lift","float","drop"].includes(i.type))xe=-i.data.offset;else if("move"===i.type){var Se=Math.floor(i.time/4),_e=i.time%4*.25,Ae=i.data.path[Se],Ie=i.data.path[Se+1];we=16*Ae[0],be=16*Ae[1],xe=-8,Ie&&(we+=(16*Ie[0]-we)*_e,be+=(16*Ie[1]-be)*_e)}f.push({sprite:ke,position:[we,be+3,xe-3]})}else f.push({sprite:ke,position:[we,be+1,xe-1]});(!i||i&&i.data.target!==me||i&&i.data.target===me&&i.time%2)&&f.push({sprite:r.shadow,position:[we,be,3]})}f.sort(function(t,e){return t.position[1]-e.position[1]});var qe=!0,ze=!1,Me=void 0;try{for(var Te,Ee=f[Symbol.iterator]();!(qe=(Te=Ee.next()).done);qe=!0){var Le=Te.value,De=_slicedToArray(Le.position,3),Ce=De[0],je=De[1],Oe=De[2];a.drawImage(Le.sprite,Math.round(Ce),Math.round(je+Oe))}}catch(t){ze=!0,Me=t}finally{try{!qe&&Ee.return&&Ee.return()}finally{if(ze)throw Me}}},(o="sprites.png",new Promise(function(t,e){var a=new Image;a.src=o,a.onload=function(){t(a)},a.onerror=function(){e(new Error("Failed to load image `"+o+"`"))}})).then(function(t){var c=m.map,v=m.ranges,p=m.cursor,e=function(t){var e={};for(var a in A){var r=_slicedToArray(A[a],4),i=r[0],o=r[1],n=r[2],l=r[3];e[a]=I(t,i,o,n,l)}e.squares={attack:I(e.squares,16,0,16,16),move:I(e.squares,0,0,16,16)},e.arrows={left:I(e.arrows,0,0,16,16),right:I(e.arrows,16,0,16,16),up:I(e.arrows,32,0,16,16),down:I(e.arrows,48,0,16,16),leftStub:I(e.arrows,0,16,16,16),rightStub:I(e.arrows,16,16,16,16),upStub:I(e.arrows,32,16,16,16),downStub:I(e.arrows,48,16,16,16),upLeft:I(e.arrows,0,32,16,16),upRight:I(e.arrows,16,32,16,16),downLeft:I(e.arrows,32,32,16,16),downRight:I(e.arrows,48,32,16,16),horiz:I(e.arrows,0,48,16,16),vert:I(e.arrows,16,48,16,16)},e.pieces={player:{},enemy:{},ally:{}};var s=e.palette.getContext("2d").getImageData(0,0,3,3),f={white:[255,255,255,255],cyan:q.get(s,0,0),blue:q.get(s,1,0),navy:q.get(s,2,0),pink:q.get(s,0,1),red:q.get(s,1,1),purple:q.get(s,2,1),lime:q.get(s,0,2),green:q.get(s,1,2),teal:q.get(s,2,2)},u={player:[f.cyan,f.blue,f.navy],enemy:[f.pink,f.red,f.purple],ally:[f.lime,f.green,f.teal]},c=["sword","lance","axe","bow","dagger","shield","hat"];for(var v in u){var p=u[v],d=!0,h=!1,y=void 0;try{for(var m,g=c[Symbol.iterator]();!(d=(m=g.next()).done);d=!0){var w=m.value,b=e["symbols/"+w],x=z(16,16),k=e.piece.getContext("2d").getImageData(0,0,16,16);q.replace(k,f.cyan,p[0]),q.replace(k,f.blue,p[1]),q.replace(k,f.navy,p[2]),x.putImageData(k,0,0);var S=z(b.width,b.height);S.drawImage(b,0,0);var _=S.getImageData(0,0,b.width,b.height);q.replace(_,f.white,p[0]),S.putImageData(_,0,0),x.drawImage(S.canvas,5,5),q.replace(_,p[0],p[2]),S.putImageData(_,0,0),x.drawImage(S.canvas,5,4),e.pieces[v][w]=x.canvas}}catch(t){h=!0,y=t}finally{try{!d&&g.return&&g.return()}finally{if(h)throw y}}}return e}(t),d=y(16*c.layout.size[0],16*c.layout.size[1],e);document.body.appendChild(d.context.canvas);for(var a=0;a<c.units.length;a++){var r=c.units[a];v[a]=h(c,r)}function l(t,e){var a=d.context.canvas,r=a.width,i=a.height;return[Math.floor(t/r*16),Math.floor(e/i*16)]}y.render(d,m),requestAnimationFrame(function t(){y.render(d,m);requestAnimationFrame(t)}),window.addEventListener("mousemove",function(t){var e=d.context.canvas;t.target===e&&(p.position=l(t.offsetX,t.offsetY))}),window.addEventListener("mousedown",function(t){var e=d.context.canvas;if(t.target===e){if(p.position||(p.position=l(t.offsetX,t.offsetY)),d.animation)return;for(var a=_slicedToArray(p.position,2),r=a[0],i=a[1],o=0;o<c.units.length;o++){var n=c.units[o];if(n.position[0]===r&&n.position[1]===i){p.selection=o;break}}}}),window.addEventListener("mouseup",function(t){if(null!==p.selection){var e=c.units[p.selection];if(p.position[0]===e.position[0]&&p.position[1]===e.position[1])return p.released?(p.released=!1,void(p.selection=null)):void(p.released=!0);var a=v[p.selection],r=!0,i=!1,o=void 0;try{for(var n,l=a.move[Symbol.iterator]();!(r=(n=l.next()).done);r=!0){var s=n.value;if(s.cell[0]===p.position[0]&&s.cell[1]===p.position[1]){e.position=p.position,d.animation={type:"move",time:0,data:{target:p.selection,path:s.path}};for(var f=0;f<c.units.length;f++){var u=c.units[f];v[f]=h(c,u)}break}}}catch(t){i=!0,o=t}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}p.released=!1,p.selection=null}})});var m={map:c.test,ranges:[],cursor:{position:null,selection:null,released:!1}}}();