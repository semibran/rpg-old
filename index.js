"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var a=[],r=!0,i=!1,o=void 0;try{for(var n,s=t[Symbol.iterator]();!(r=(n=s.next()).done)&&(a.push(n.value),!e||a.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return a}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};!function(){var o={squares:{move:[0,0,16,16],attack:[16,0,16,16]},pieces:{player:{sword:[0,0,16,18],axe:[16,0,16,18],shield:[32,0,16,18],bow:[48,0,16,18]},enemy:{sword:[0,18,16,18],axe:[16,18,16,18],shield:[32,18,16,18],bow:[48,18,16,18]},ally:{sword:[0,36,16,18],axe:[16,36,16,18],shield:[32,36,16,18],bow:[48,36,16,18]}}},j={soldier:"sword",warrior:"axe",knight:"shield",archer:"bow"};Promise.all(["./sprites/grass.png","./sprites/wall.png","./sprites/pieces.png","./sprites/shadow.png","./sprites/squares.png"].map(function(t){return r=t,new Promise(function(t,e){var a=new Image;a.src=r,a.onload=function(){t(a)},a.onerror=function(){e(new Error("Failed to load image `"+r+"`"))}});var r})).then(function(t){t={floor:t[0],wall:t[1],shadow:t[3],squares:c(t[4],o.squares),pieces:c(t[2],o.pieces)};var s=n.map,l=n.cursor,f=(e=16*s.size[0],a=16*s.size[1],r=t,i=document.createElement("canvas"),i.width=e,i.height=a,{context:i.getContext("2d"),sprites:r,animation:null,squares:null});var e,a,r,i;document.body.appendChild(f.context.canvas),u(f,n),requestAnimationFrame(function t(){u(f,n);requestAnimationFrame(t)}),window.addEventListener("mousemove",function(t){var e,a,r,i,o,n=f.context.canvas;t.target===n&&(l.position=(e=t.offsetX,a=t.offsetY,r=f.context.canvas,i=r.width,o=r.height,[Math.floor(e/i*16),Math.floor(a/o*16)]))}),window.addEventListener("mousedown",function(t){var e=f.context.canvas;if(t.target===e)for(var a=_slicedToArray(l.position,2),r=a[0],i=a[1],o=0;o<s.units.length;o++){var n=s.units[o];if(n.position[0]===r&&n.position[1]===i){l.selection=o;break}}}),window.addEventListener("mouseup",function(t){null!==l.selection&&(l.selection=null)})});var n={map:{size:[16,16],layout:[1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1],units:[{class:"soldier",faction:"player",position:[6,7]},{class:"knight",faction:"player",position:[7,9]},{class:"warrior",faction:"enemy",position:[8,6]},{class:"archer",faction:"ally",position:[9,8]}]},cursor:{position:null,selection:null}};function u(t,e){for(var a=t.context,r=t.sprites,i=t.animation,o=t.squares,n=e.map,s=e.cursor,l=0;l<n.size[0];l++)for(var f=0;f<n.size[1];f++){var u=l*n.size[0]+f;0===n.layout[u]&&a.drawImage(r.floor,16*f,16*l)}if(i&&i.time++,null!==s.selection)if(i){if("lift"===i.type&&8<=i.time&&(i=t.animation={type:"float",time:0,data:{target:s.selection,offset:0}},!o)){var c=n.units[s.selection],d="soldier"===c.class?4:3;o=t.squares=function(t,e){e=e||1;for(var a=t,r=[a],i=[a];i.length;){var o=i.shift(),n=Math.abs(o[0]-a[0])+Math.abs(o[1]-a[1]),s=[[o[0]-1,o[1]],[o[0]+1,o[1]],[o[0],o[1]-1],[o[0],o[1]+1]],l=!0,f=!1,u=void 0;try{for(var c,d=s[Symbol.iterator]();!(l=(c=d.next()).done);l=!0){var p=c.value,v=!0,h=!0,m=!1,y=void 0;try{for(var w,g=r[Symbol.iterator]();!(h=(w=g.next()).done);h=!0){var b=w.value;if(b[0]===p[0]&&b[1]===p[1]){v=!1;break}}}catch(t){m=!0,y=t}finally{try{!h&&g.return&&g.return()}finally{if(m)throw y}}v&&(r.push(p),n+1<e&&i.push(p))}}catch(t){f=!0,u=t}finally{try{!l&&d.return&&d.return()}finally{if(f)throw u}}}return r}(c.position,d);for(var p=0;p<o.length;p++)for(var v=o[p],h=0;h<n.units.length;h++){var m=n.units[h];if(v[0]===m.position[0]&&v[1]===m.position[1]){o.splice(p,1);break}}}}else i=t.animation={type:"lift",time:0,data:{target:s.selection,offset:0}};else o=t.squares=null,i&&"drop"!==i.type&&(i=t.animation={type:"drop",time:0,data:{target:i.data.target,offset:i.data.offset}});if(o){var y=!0,w=!1,g=void 0;try{for(var b,x=o[Symbol.iterator]();!(y=(b=x.next()).done);y=!0){var q=b.value,M=_slicedToArray(q,2),A=M[0],z=M[1];a.drawImage(r.squares.move,16*A,16*z)}}catch(t){w=!0,g=t}finally{try{!y&&x.return&&x.return()}finally{if(w)throw g}}}for(var I=0;I<n.units.length;I++){var E=n.units[I],k=16*E.position[0],S=16*E.position[1],T=r.pieces[E.faction][j[E.class]],_=S;if(i&&I===i.data.target){if("lift"===i.type)i.data.offset=Math.min(8,i.time);else if("float"===i.type){var C=i.time%180/180;i.data.offset=8+2*Math.sin(2*Math.PI*C)}else"drop"===i.type&&--i.data.offset<0&&(i.data.offset=0,t.animation=null);_-=i.data.offset}(!i||i&&i.data.target!==I||i&&i.data.target===I&&i.time%2)&&a.drawImage(r.shadow,Math.round(k),Math.round(S+2)),a.drawImage(T,Math.round(k),Math.round(_-2))}for(var F=0;F<n.size[0];F++)for(var L=0;L<n.size[1];L++){var P=F*n.size[0]+L;1===n.layout[P]&&a.drawImage(r.wall,16*L,16*F-8)}}function c(t,e,a){for(var r in a=a||{},e)if(Array.isArray(e[r])){var i=_slicedToArray(e[r],4),o=i[0],n=i[1],s=i[2],l=i[3],f=document.createElement("canvas");f.width=s,f.height=l,f.getContext("2d").drawImage(t,-o,-n),a[r]=f}else a[r]=c(t,e[r]);return a}}();