"use strict";var _slicedToArray=function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,a){var e=[],r=!0,o=!1,n=void 0;try{for(var i,l=t[Symbol.iterator]();!(r=(i=l.next()).done)&&(e.push(i.value),!a||e.length!==a);r=!0);}catch(t){o=!0,n=t}finally{try{!r&&l.return&&l.return()}finally{if(o)throw n}}return e}(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")};!function(){var a={squares:[0,48,32,16],shadow:[0,64,16,16],arrows:[0,0,64,48],floor:[48,48,16,16],grass:[64,32,16,16],wall:[64,0,16,32],piece:[32,48,16,21],"symbols/shield":[32,69,8,8],"symbols/bow":[16,64,8,8],"symbols/dagger":[64,48,8,8],"symbols/sword":[24,64,8,8],"symbols/axe":[48,64,8,8],"symbols/hat":[40,69,8,8],"symbols/lance":[16,72,8,8]};function A(t){return function(t,a){var e={};for(var r in a){var o=_slicedToArray(a[r],4),n=o[0],i=o[1],l=o[2],s=o[3],d=document.createElement("canvas"),u=d.getContext("2d");d.width=l,d.height=s,u.drawImage(t,-n,-i),e[r]=d}return e}(t,a)}var t={tiles:[{name:"grass",solid:!1},{name:"wall",solid:!0},{name:"floor",solid:!1}],layout:{size:[16,16],data:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},units:[{class:"knight",faction:"enemy",position:[7,8]},{class:"knight",faction:"enemy",position:[8,8]},{class:"mage",faction:"enemy",position:[5,4]},{class:"warrior",faction:"player",position:[6,11]},{class:"thief",faction:"player",position:[11,12]},{class:"mage",faction:"ally",position:[8,13]}]},e=t.tiles,r=t.layout,o=t.units,n=Object.freeze({default:t,__moduleExports:t,tiles:e,layout:r,units:o}),i={test:n&&t||n},v={units:{thief:{move:5,range:1},knight:{move:3,range:1},warrior:{move:4,range:1},mage:{move:4,range:2}}},qt=function(t,a){for(var e=v.units[a.class].move,r=[],o=[{cell:a.position,path:[a.position]}];o.length;)for(var n=o.shift(),i=[[n.cell[0]-1,n.cell[1]],[n.cell[0]+1,n.cell[1]],[n.cell[0],n.cell[1]-1],[n.cell[0],n.cell[1]+1]],l=0;l<i.length;l++){var s=(c=i[l])[0],d=c[1]*t.layout.size[0]+s;if(1!==t.layout.data[d]){for(var u=0;u<r.length;u++){if(h(c,r[u].cell))break}if(!(u<r.length)){for(u=0;u<t.units.length;u++){if(h(c,(a=t.units[u]).position))break}if(!(u<t.units.length)){var f=n.path.slice();f.push(c);var c={cell:c,path:f};r.push(c),f.length-1<e&&o.push(c)}}}}return r};function h(t,a){return t[0]===a[0]&&t[1]===a[1]}var l,St={soldier:"sword",lancer:"lance",warrior:"axe",archer:"bow",thief:"dagger",knight:"shield",mage:"hat"};function M(t,a,e){var r=document.createElement("canvas");return r.width=t,r.height=a,{context:r.getContext("2d"),sprites:e,animation:null,nodes:null}}M.render=function(t,a){for(var e=t.context,r=t.sprites,o=t.animation,n=t.nodes,i=a.map,l=a.cursor,s=[],d=[],u=0;u<i.layout.size[1];u++)for(var f=0;f<i.layout.size[0];f++){var c=u*i.layout.size[0]+f,v=i.layout.data[c];i.tiles[v].solid?d.push({id:v,cell:[f,u]}):s.push({id:v,cell:[f,u]})}var h=!0,m=!1,g=void 0;try{for(var y,p=s[Symbol.iterator]();!(h=(y=p.next()).done);h=!0){var w=y.value,b=i.tiles[w.id],x=_slicedToArray(w.cell,2),I=x[0],A=x[1];e.drawImage(r[b.name],16*I,16*A)}}catch(t){m=!0,g=t}finally{try{!h&&p.return&&p.return()}finally{if(m)throw g}}if(o&&o.time++,null!==l.selection){var M=i.units[l.selection];if(o){if("lift"===o.type)o.time<8?o.data.offset=o.time:(o=t.animation={type:"float",time:0,data:{target:l.selection,offset:0,range:0}},n||(n=t.nodes=qt(i,M)));else if("float"===o.type){var k=0,z=!0,E=!1,_=void 0;try{for(var T,q=n[Symbol.iterator]();!(z=(T=q.next()).done);z=!0){var S=T.value,C=_slicedToArray(S.cell,2),L=C[0],D=C[1],R=Math.abs(L-M.position[0])+Math.abs(D-M.position[1]);R<=o.time&&e.drawImage(r.squares.move,16*L,16*D),k<R&&(k=R)}}catch(t){E=!0,_=t}finally{try{!z&&q.return&&q.return()}finally{if(E)throw _}}o.data.range=k;var B=null,F=!0,j=!1,O=void 0;try{for(var P,X=n[Symbol.iterator]();!(F=(P=X.next()).done);F=!0){var Y=P.value;if(Y.cell[0]===l.position[0]&&Y.cell[1]===l.position[1]){B=Y.path;break}}}catch(t){j=!0,O=t}finally{try{!F&&X.return&&X.return()}finally{if(j)throw O}}if(B)for(var G=1;G<B.length;G++){var H=_slicedToArray(B[G],2),J=H[0],K=H[1],N=!1,Q=!1,U=!1,V=!1,W=B[G-1],Z=J-W[0],$=K-W[1];1===Z?N=!0:-1===Z&&(Q=!0),1===$?U=!0:-1===$&&(V=!0);var tt=B[G+1];if(tt){var at=tt[0]-J,et=tt[1]-K;-1===at?N=!0:1===at&&(Q=!0),-1===et?U=!0:1===et&&(V=!0)}if(N||Q||U||V){var rt=null;N&&Q?rt="horiz":U&&V?rt="vert":U&&N?rt="upLeft":U&&Q?rt="upRight":V&&N?rt="downLeft":V&&Q?rt="downRight":N?rt="left":Q?rt="right":U?rt="up":V&&(rt="down"),rt&&e.drawImage(r.arrows[rt],16*J,16*K)}}var ot=o.time%180/180;o.data.offset=8+2*Math.sin(2*Math.PI*ot)}}else o=t.animation={type:"lift",time:0,data:{target:l.selection,offset:0}}}else if(o){var nt=i.units[o.data.target];if("drop"!==o.type)o=t.animation={type:"drop",time:0,data:{target:o.data.target,offset:o.data.offset,range:o.data.range}};else{if(n){var it=!0,lt=!1,st=void 0;try{for(var dt,ut=n[Symbol.iterator]();!(it=(dt=ut.next()).done);it=!0){var ft=dt.value,ct=_slicedToArray(ft.cell,2),vt=ct[0],ht=ct[1];Math.abs(vt-nt.position[0])+Math.abs(ht-nt.position[1])<=o.data.range-o.time&&e.drawImage(r.squares.move,16*vt,16*ht)}}catch(t){lt=!0,st=t}finally{try{!it&&ut.return&&ut.return()}finally{if(lt)throw st}}}--o.data.offset<0&&(o.data.offset=0,t.animation=null,n=t.nodes=null)}}var mt=!0,gt=!1,yt=void 0;try{for(var pt,wt=d[Symbol.iterator]();!(mt=(pt=wt.next()).done);mt=!0){var bt=pt.value,xt=_slicedToArray(bt.cell,2),It=xt[0],At=xt[1];e.drawImage(r.wall,16*It,16*At-8)}}catch(t){gt=!0,yt=t}finally{try{!mt&&wt.return&&wt.return()}finally{if(gt)throw yt}}for(var Mt=0;Mt<i.units.length;Mt++){var kt=i.units[Mt],zt=16*kt.position[0],Et=16*kt.position[1],_t=Et,Tt=r.pieces[kt.faction][St[kt.class]];o&&Mt===o.data.target&&(_t-=o.data.offset),(!o||o&&o.data.target!==Mt||o&&o.data.target===Mt&&o.time%2)&&e.drawImage(r.shadow,Math.round(zt),Math.round(Et+2)),e.drawImage(Tt,Math.round(zt),Math.round(_t-2))}},(l="sprites.png",new Promise(function(t,a){var e=new Image;e.src=l,e.onload=function(){t(e)},e.onerror=function(){a(new Error("Failed to load image `"+l+"`"))}})).then(function(t){var l=k.map,s=k.cursor,a=A(t);a.squares={attack:_(a.squares,16,0,16,16),move:_(a.squares,0,0,16,16)},a.arrows={left:_(a.arrows,0,0,16,16),right:_(a.arrows,16,0,16,16),up:_(a.arrows,32,0,16,16),down:_(a.arrows,48,0,16,16),upLeft:_(a.arrows,0,16,16,16),upRight:_(a.arrows,16,16,16,16),downLeft:_(a.arrows,32,16,16,16),downRight:_(a.arrows,48,16,16,16),horiz:_(a.arrows,0,32,16,16),vert:_(a.arrows,16,32,16,16)},a.pieces={player:{},enemy:{},ally:{}},console.log(a);var e=_(a.piece,0,18,3,3).getContext("2d").getImageData(0,0,3,3),r={white:[255,255,255,255],lightBlue:z(e,0,0),blue:z(e,1,0),darkBlue:z(e,2,0)},o={player:[z(e,0,0),z(e,1,0),z(e,2,0)],enemy:[z(e,0,1),z(e,1,1),z(e,2,1)],ally:[z(e,0,2),z(e,1,2),z(e,2,2)]},n=["sword","lance","axe","bow","dagger","shield","hat"];for(var i in o){var d=o[i],u=!0,f=!1,c=void 0;try{for(var v,h=n[Symbol.iterator]();!(u=(v=h.next()).done);u=!0){var m=v.value,g=a["symbols/"+m],y=T(16,18),p=a.piece.getContext("2d").getImageData(0,0,16,18);E(p,r.blue,d[1]),E(p,r.darkBlue,d[2]),y.putImageData(p,0,0);var w=T(g.width,g.height);w.drawImage(g,0,0);var b=w.getImageData(0,0,g.width,g.height);E(b,r.white,d[0]),w.putImageData(b,0,0),y.drawImage(w.canvas,4,5),E(b,d[0],d[2]),w.putImageData(b,0,0),y.drawImage(w.canvas,4,4),a.pieces[i][m]=y.canvas}}catch(t){f=!0,c=t}finally{try{!u&&h.return&&h.return()}finally{if(f)throw c}}}var x=M(16*l.layout.size[0],16*l.layout.size[1],a);function I(t,a){var e=x.context.canvas,r=e.width,o=e.height;return[Math.floor(t/r*16),Math.floor(a/o*16)]}document.body.appendChild(x.context.canvas),M.render(x,k),requestAnimationFrame(function t(){M.render(x,k);requestAnimationFrame(t)}),window.addEventListener("mousemove",function(t){var a=x.context.canvas;t.target===a&&(s.position=I(t.offsetX,t.offsetY))}),window.addEventListener("mousedown",function(t){var a=x.context.canvas;if(t.target===a){s.position||(s.position=I(t.offsetX,t.offsetY));for(var e=_slicedToArray(s.position,2),r=e[0],o=e[1],n=0;n<l.units.length;n++){var i=l.units[n];if(i.position[0]===r&&i.position[1]===o){s.selection=n;break}}}}),window.addEventListener("mouseup",function(t){null!==s.selection&&(s.selection=null)})});var k={map:i.test,cursor:{position:null,selection:null}};function z(t,a,e){var r=4*(e*t.width+a);return[t.data[r],t.data[r+1],t.data[r+2],t.data[r+3]]}function E(t,a,e){for(var r=0;r<t.data.length;r+=4){for(var o=0;o<4&&t.data[r+o]===a[o];o++);if(4===o)for(o=0;o<4;o++)t.data[r+o]=e[o]}}function _(t,a,e,r,o){var n=document.createElement("canvas"),i=n.getContext("2d");return n.width=r,n.height=o,i.drawImage(t,-a,-e),n}function T(t,a){var e=document.createElement("canvas");return e.width=t,e.height=a,e.getContext("2d")}}();